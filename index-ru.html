<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
		"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

		<title>Node.js для начинающих » Подробный учебник по Node.js </title>
		<meta name="description" content="Подробный учебник по Node.js для начинающих: Научитесь создавать полномасштабные веб-приложения с серверными JavaScript" />
		
		<link rel="icon" href="favicon.png" type="image/png" />
		<link rel="stylesheet" type="text/css" href="default-ru.css" />

	</head>
	<body>
		<div id="forkmeongithub">
			<a href="https://github.com/ManuelKiessling/NodeBeginnerBook"><img src="fork_me_on_github.png" width="149" height="149" alt="Fork me on GitHub" /></a>
		</div>
		
		<div id="translations">
			<table>
				<tr>
					<td>
						<a href="http://nodebeginner.org/index-jp.html">
							<div class="flag">
								<img src="jp-flag.png" width="24" height="24" alt="japanese flag"/>
							</div>
							<div class="text">日本語で読む</div>
						</a>
					</td>
					<td>
						<a href="http://nodebeginner.org/index-es.html">
							<div class="flag"><img src="es-flag.png" width="24" height="24" alt="spanish flag" /></div>
							<div class="text">Lee este tutorial en Español</div>
						</a>
					</td>
					<td>
						<a href="http://nodebeginner.org/index-kr.html">
							<div class="flag"><img src="kr-flag.png" width="24" height="24" alt="korean flag" /></div>
							<div class="text">이 튜토리얼을 한글로 보세요</div>
						</a>
					</td>
				</tr>
				<tr>
					<td>
						<a href="http://nodebeginner.org/index-zh-cn.html">
							<div class="flag"><img src="cn-flag.png" width="24" height="24" alt="chinese flag" /></div>
							<div class="text">阅读本书中文版</div>
						</a>
					</td>
					<td>
						<a href="http://nodebeginner.org/index-zh-tw.html">
							<div class="flag"><img src="cn-flag.png" width="24" height="24" alt="chinese flag" /></div>
							<div class="text">阅读本书繁体中文版</div>
						</a>
					</td>
					<td>
						<a href="http://nodebeginner.org">
							<div class="flag"><img src="us-flag.png" width="24" height="24" alt="usa flag" /></div>
							<div class="text">Read this tutorial in english</div>
						</a>
					</td>
				</tr>
			</table>
		</div>		
		
		<div id="book">
		<h1>Node.js для начинающих</h1>

		<div id="author">Автор: <a href="http://twitter.com/manuelkiessling">Manuel Kiessling</a></div>
		<div style="color:#888; font-family:'Helvetica Neue', sans-serif; font-size:75%; margin-left:279px; margin-top:5px;"><a href="http://www.nodebeginner.ru/">Перевод</a>: <a href="http://artod.ru/">Artod</a>, правка 2013-03-24, spmbt</div>

		<a name="about"></a>
		
		<h2>О проекте</h2>

		<p>
			Цель данного документа &mdash; помочь вам начать разработку приложений на Node.js и научить всему, что необходимо знать о «продвинутом» JavaScript.
			Это больше, чем обычный «Hello world»-туториал.
		</p>
		
		<a name="status"></a>

		<h3>Статус</h3>

		<p>
			Вы читаете финальную версию этой книги, в обновлениях исправляются только ошибки или отражаются изменения в новых версиях Node.js. Последнее обновление 12 Февраля 2012.
		</p>

		<p>
			Код примеров этой книги тестировался на <u><b>Node.js версии 0.8.8</b></u> <i style="color:#999">(проверено по англ. версии --прим.перев.)</i>.
		</p>

		<a name="intended-audience"></a>
		
		<h3>Целевая аудитория</h3>
		
		<p>
			Вероятно, документ будет полезен читателям с базовыми знаниями, примерно, как у меня: опыт работы хотя бы с одним объектно-ориентированным языком, таким как Ruby, Python, PHP или Java, небольшой опыт в Javascript и полный новичок в Node.js.
		</p>
		<p>
			Документ рассчитан на разработчиков, уже знакомых с другими языками программирования.
			Это значит, что здесь не приводится объяснение действительно базовых вещей, таких как типы данных, переменные, управляющие структуры и т. д.
			Вы должные разбираться в этих понятиях, чтобы понимать эту книгу.
		</p>
		<p>
			Однако, поскольку функции и объекты в JavaScript отличаются от своих аналогов в других языках, они будут описаны достаточно подробно.
		</p>

		<a name="structure"></a>
		
		<h3>Структура учебника</h3>
		
		<p>
			Прочитав данный документ до конца, вы сможете создать веб-приложение, которое позволит пользователям просматривать веб-страницы и загружать файлы.
		</p>
		<p>
			Это, конечно, не изменит мир, но мы будем стараться и научимся писать не просто куски кода, которых «достаточно», чтобы сделать это возможным, но и создадим простой, полноценный framework для чистого разделения различных аспектов вашего приложения.
			Скоро вы увидите, что я имею в виду.
		</p>
		<p>
			Мы начнём с выяснения того, чем JavaScript в Node.js отличается от JavaScript в браузере.
		</p>
		<p>
			Далее, мы остановимся на написании традиционного «Hello world»-приложения, которое является наиболее простым примером «что-то делающего» кода Node.js.
		</p>
		<p>
			Тогда мы обсудим, какое «реальное» приложение мы хотим создать, проанализируем компоненты, которые необходимо реализовать для написания данного приложения, и начнём работать над каждым из них, шаг за шагом.
		</p>
		<p>
			Как и было обещано, по пути мы узнаем о некоторых продвинутых понятиях JavaScript, о том как их использовать и посмотрим, почему разумно использовать эти понятия вместо привычных нам в других языках программирования.
		</p>
		<p>
			Исходный код законченного приложения доступен в
			<a href="https://github.com/ManuelKiessling/NodeBeginnerBook/tree/master/code/application">the NodeBeginnerBook Github репозитории</a>.
		</p>

		<div id="table-of-contents-headline">Содержание</div>
		<div id="table-of-contents">
			<ul>

				<li><a href="#about">О проекте</a>
					<ul>
						<li><a href="#status">Статус</a></li>
						<li><a href="#intended-audience">Целевая аудитория</a></li>
						<li><a href="#structure">Структура учебника</a></li>
					</ul>
				</li>

				<li><a href="#javascript-and-nodejs">JavaScript и Node.js</a>
					<ul>
						<li><a href="#javascript-and-you">JavaScript и Вы</a></li>
						<li><a href="#a-word-of-warning">Предупреждение</a></li>
						<li><a href="#server-side-javascript">Server-side JavaScript</a></li>
						<li><a href="#hello-world">"Hello World"</a></li>

					</ul>
				</li>
				<li><a href="#a-full-blown-web-application-with-nodejs">Полномасштабное веб-приложение с Node.js</a>
					<ul>
						<li><a href="#the-use-cases">Что должно делать наше приложение</a></li>
						<li><a href="#the-application-stack">Задачи</a></li>
					</ul>

				</li>
				<li><a href="#building-the-application-stack">Реализация приложения</a>
					<ul>
						<li><a href="#a-basic-http-server">Простой HTTP-сервер</a></li>
						<li><a href="#analyzing-our-http-server">Анализ нашего HTTP-сервера</a></li>
						<li><a href="#passing-functions-around">Передача функций в качестве параметра</a></li>
						<li><a href="#how-function-passing-makes-our-http-server-work">Как анонимная функция делает наш HTTP-сервер рабочим</a></li>

						<li><a href="#event-driven-callbacks">Событийно-ориентированные обратные вызовы</a></li>
						<li><a href="#how-our-server-handles-requests">Как наш сервер обрабатывает запросы</a></li>
						<li><a href="#finding-a-place-for-our-server-module">Выбор места для нашего серверного модуля</a>
						</li>
						<li><a href="#whats-needed-to-route-requests">Что необходимо для «роутера»?</a></li>
						<li><a href="#execution-in-the-kongdom-of-verbs">Исполнение королевских постановлений в царстве глаголов</a></li>
						<li><a href="#routing-to-real-request-handlers">Роутинг реальных обработчиков запроса</a></li>

						<li><a href="#making-the-request-handlers-respond">Создание ответа обработчиков запроса</a>
							<ul>
								<li><a href="#how-to-not-do-it">Как делать не надо</a></li>
								<li><a href="#blocking-and-non-blocking">Блокирование и неблокирование</a></li>
								<li><a href="#responding-request-handlers-with-non-blocking-operations">Ответ обработчиков запроса с неблокирующими операциями.</a>
								</li>
							</ul>

						</li>
						<li><a href="#serving-something-useful">Сделаем что-нибудь полезное</a>
							<ul>
								<li><a href="#handling-post-requests">Обработка POST-запросов</a></li>
								<li><a href="#handling-file-uploads">Обработка загрузки файлов</a></li>
							</ul>
						</li>

						<li><a href="#conclusion-and-outlook">Выводы и перспективы</a></li>
					</ul>
				</li>
			</ul>
		
		</div>
		
		<a name="javascript-and-nodejs"></a>

		<h2>JavaScript и Node.js</h2>

		<h3>JavaScript и Вы</h3>
		<p>
			До того как мы поговорим о технических вещах, позвольте занять некоторое время и поговорить о вас и ваших отношениях с JavaScript.
			Эта глава позволит вам понять, имеет ли смысл читать дальше.
		</p>
		<p>
			Скорее всего, как и в моем случае, вы начали свой путь в веб-разработке с написания простых статических HTML-документов.
			Вместе с этим, вы познакомились с веселой штукой, называемой JavaScript, но использовали его исключительно в простых случаях, добавляя интерактивности на ваши веб-странички.
		</p>
		<p>
			Что вы хотели узнать &mdash; так это действительно полезные вещи; вы хотели знать, как создать сложный сайт.
			Для этого вы изучали PHP, Ruby, Java и начинали писать backend-код.
		</p>
		<p>
			Тем не менее, вы постоянно следили за JavaScript, вы видели, что с появлениям JQuery, Prototype и других фреймворков этот язык стал больше, чем просто <em>window.open()</em>.
		</p>
		<p>
			Однако, это всё ещё относилось к frontend-разработке.
			Конечно, jQuery &mdash; очень мощный инструмент, но всякий раз, когда вы приправляли ваш сайт разными jQuery-«фишками», в лучшем случае, вы были JavaScript-<em>пользователем</em> нежели JavaScript-<em>разработчиком</em>.
		</p>
		<p>
			А потом пришел Node.js. JavaScript на сервере: насколько это хорошо?
		</p>
		<p>
			И вы решили, что пора проверить старый новый JavaScript.
			Подождите. Написать Node.js приложение &mdash; одно дело, а понять, почему оно должно быть написано таким образом, для этого нужно понимать JavaScript.
			И на этот раз &mdash; по-настоящему.
		</p>
		<p>
			В этом &mdash; как раз и проблема.
			JavaScript живёт двумя, может даже тремя разными жизнями: весёлый маленький DHMTL-помощник из середины 90-х годов, более серьезный frontend-инструмент в лице jQuery и наконец серверный (server-side, backend) JavaScript.
			По этой причине не так просто найти информацию, которая поможет вам познать правильный JavaScript, пригодный для написания Node.js приложения в манере, дающий ощущение, что вы не просто использовали JavaScript, а действительно разрабатывали на JavaScript.
		</p>
		<p>
			Это &mdash; наиболее правильный подход.
			Вы &mdash; уже опытный разработчик, вы не хотите изучать новые технологии поверхностно, просто валяя дурака.
			Вы хотите быть уверенным, что вы подходите к проблеме под правильным углом.
		</p>
		<p>
			Конечно, существует отличная документация по Node.js, но её зачастую недостаточно. Нужно руководство.
		</p>
		<p>
			Моя цель заключается в обеспечении вас руководством.
		</p>
		
		<a name="a-word-of-warning"></a>

		<h3>Предупреждение</h3>
		
		<p>
			Существуют действительно отличные специалисты в области JavaScript. Я не из их числа.
		</p>
		<p>
			Я &mdash; действительно, тот парень, о котором написано в предыдущем параграфе.
			Я знаю кое-что о разработке backend веб-приложений, но я всё ещё новичок в «реальном» JavaScript и всё ещё новичок в Node.js.
			Я узнал некоторые продвинутые аспекты JavaScript совсем недавно.
			Я неопытен.
		</p>
		<p>
			Вот почему эта книга не из разряда «от новичка к эксперту», а скорее «от новичка к продвинутому новичку».
		</p>
		<p>
			Если всё удастся, то этот документ станет тем руководством, которое я хотел бы иметь, когда начинал в Node.js.
		</p>

		<a name="server-side-javascript"></a>
		
		<h3>Server-side JavaScript</h3>
		
		<p>
			Первая инкарнация JavaScript жила в теле браузера.
			Но это всего лишь контекст.
			Он определяет, что вы можете делать с языком, но не говорит о том, что язык сам по себе может сделать.
			JavaScript это «полноценный» язык: вы можете использовать его в различных контекстах и достичь всего того, что можете достичь с другими «полноценными» языками.
		</p>
		<p>
			Node.js &mdash; действительно, просто другой контекст: он позволяет вам запускать JavaScript-код вне браузера.
		</p>
		<p>
			Чтобы ваш JavaScript код выполнился на <em>вычислительной машине вне браузера</em> (на <strong>backend</strong>), он должен быть интерпретирован и, конечно же, выполнен.
			Именно это и делает Node.js. Для этого он использует движок V8 VM от Google &mdash; ту же самую среду исполнения для JavaScript, которую использует браузер Google Chrome.
		</p>
		<p>
			Кроме того, Node.js поставляется со множеством полезных модулей, так что вам не придется писать всё с нуля, как, например, вывод строки в консоль.
		</p>
		<p>
			Таким образом, Node.js состоит из 2 вещей: среды исполнения и полезных библиотек.
		</p>
		<p>
			Для того чтобы их использовать, вам необходимо установить Node.js.
			Вместо повторения всего процесса установки здесь, я просто приглашу вас посетить <a href="https://github.com/joyent/node/wiki/Installation" title="Building and Installing Node.js">официальную инструкцию по инсталляции</a>.
			Пожалуйста, вернитесь обратно после успешной установки.
		</p>

		<a name="hello-world"></a>
		
		<h3>«Hello world»</h3>
		<p>
			Хорошо, давайте пойдём сразу с места в карьер и напишем наше первое Node.js-приложение: «Hello world».
		</p>
		<p>
			Откройте ваш любимый редактор и создайте файл под названием <em>helloworld.js</em>.
			Мы хотим вывести строку «Hello world» в консоль, для этого пишем следующий код:
		</p>
		<pre class="prettyprint lang-js"><span class="pln">console</span><span class="pun">.</span><span
				class="pln">log</span><span class="pun">(</span><span class="str">"Hello World"</span><span class="pun">);</span></pre>
		<p>
			Сохраняем файл и выполняем его посредством Node.js:
		</p>
		
		<pre>node helloworld.js</pre>
		
		<p>
			Это должно вывести <em>Hello World</em> на наш терминал.
		</p>
		<p>
			Ладно, всё это скучно, правда? Давайте напишем что-нибудь полезное.
		</p>

		<a name="a-full-blown-web-application-with-nodejs"></a>
		
		<h2>Полномасштабное веб-приложение с Node.js</h2>
		
		<a name="the-use-cases"></a>
		
		<h3>Что должно делать наше приложение</h3>
		<p>
			Возьмём что-нибудь попроще, но приближенное к реальности:
		</p>
		<ul>
			<li>
				Пользователь должен иметь возможность использовать наше приложение с браузером;
			</li>
			<li>
				Пользователь должен видеть страницу приветствия по адресу http://<em>domain</em>/start;
			</li>
			<li>
				Когда запрашивается http://<em>domain</em>/upload, пользователь должен иметь возможность загрузить картинку со своего компьютера и просмотреть её в своем браузере.
			</li>
		</ul>
		<p>
			Вполне достаточно. Конечно, вы могли бы достичь этой цели, немного погуглив и поговнокодив. Но это не то, что нам нужно.
		</p>
		<p>
			Кроме того, мы не хотим писать только простой код для достижения цели, каким бы он элегантным и корректным ни был.
			Мы будем интенсивно наращивать больше абстракции, чем это необходимо, чтобы понять как создавать более сложные Node.js-приложения.
		</p>

		<a name="the-application-stack"></a>
		
		<h3>Задачи</h3>
		
		<p>
			Давайте проанализируем наше приложение.
			Что нужно, чтобы его реализовать:
		</p>
		<ul>
			<li>
				У нас &mdash; онлайн веб-приложение, поэтому нам нужен <strong>HTTP-сервер</strong>;
			</li>
			<li>
				Нашему серверу необходимо обслуживать различные запросы в зависимости от URL, по которому был сделан запрос. Для этого нам нужен какой-нибудь роутер (маршрутизатор), чтобы иметь возможность направлять запросы определенным обработчикам;
			</li>
			<li>
				Для выполнения запросов, пришедших на сервер и направляемые роутером, нам нужны действующие <strong>обработчики запросов</strong>;
			</li>
			<li>
				Роутер, вероятно, должен иметь дело с разными входящими POST-данными и передавать их обработчикам запросов в удобной форме. Для этого нам нужен какой-нибудь <strong>обработчик входных данных</strong>;
			</li>
			<li>
				Мы хотим не только обрабатывать запросы, но и показывать пользователю контент по запрошенным URL-адресам, поэтому нам нужна некая <strong>логика отображения</strong> для обработчиков запросов, чтобы иметь возможность отправлять контент пользовательскому браузеру;
			</li>
			<li>
				Последнее, но не менее важное &mdash; пользователь сможет загружать картинки, поэтому нам нужен какой-нибудь <strong>обработчик загрузки</strong>, который возьмёт на себя заботу о деталях.
			</li>
		</ul>
		<p>
			Давайте подумаем о том, как бы мы реализовали это на PHP.
			Скорее всего, типичное решение будет на HTTP-сервере Apache с установленным mod_php5.
			<br/>
			Это относится к первому пункту наших задач, то есть, «принимать HTTP-запросы и отправлять готовые веб-странички пользователю» &mdash; вещи, которые PHP сам не делает.
		</p>
		<p>
			С Node.js &mdash; немного иначе.
			Потому что в Node.js мы не только создаем наше приложение, мы также реализуем полноценный HTTP-сервер.
			Действительно, наше веб-приложение и веб-сервер &mdash; в сущности, одно и тоже.
		</p>
		<p>
			Может показаться, что это приведет к лишней работе, но сейчас вы увидите, что с Node.js это не так.
		</p>
		<p>
			Давайте просто начнём реализовывать нашу первую задачу &mdash; HTTP-сервер.
		</p>

		<a name="building-the-application-stack"></a>
		
		<h2>Реализация приложения</h2>
		
		<a name="a-basic-http-server"></a>
		
		<h3>Простой HTTP-сервер</h3>
		
		<p>
			Когда я подошел к моменту создания своего первого «реального» Node.js-приложения, я задался вопросом, как организовать мой код.
			<br/>
			Я должен делать всё в одном файле?
			Большинство учебных пособий в интернете учат как создавать простой HTTP-сервер в Node.js, сохраняя всю логику в одном месте.
			Что, если я хочу быть уверенным, что мой код останется читабельным по мере реализации всё большего функционала.
		</p>
		<p>
			На самом деле, достаточно легко отыскивать проблемные участки вашего кода, который разделён на модули.
		</p>
		<p>
			Это позволяет вам иметь чистый главный файл, который вы исполняете в Node.js и чистые модули, которые могут использоваться главным файлом и друг другом.
		</p>
		<p>
			Так, давайте создадим главный файл, который мы будем использовать для запуска нашего приложения, и файл модуля, в котором будет находиться наш HTTP-сервер.
		</p>
		<p>
			Я думаю, это более-менее традиционно назвать главным файлом <em>index.js</em>.
			А код нашего сервера имеет смысл поместить в файл под названием <em>server.js</em>.
		</p>
		<p>
			Давайте начнём с модуля сервера.
			Создайте файл <em>server.js</em> в корневой директории вашего проекта и поместите туда следующий код:
		</p>
		
		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> http </span><span
				class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span
				class="str">"http"</span><span class="pun">);</span><span class="pln"><br><br>http</span><span
				class="pun">.</span><span class="pln">createServer</span><span class="pun">(</span><span class="kwd">function</span><span
				class="pun">(</span><span class="pln">request</span><span class="pun">,</span><span class="pln"> response</span><span
				class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; response</span><span
				class="pun">.</span><span class="pln">writeHead</span><span class="pun">(</span><span
				class="lit">200</span><span class="pun">,</span><span class="pln"> </span><span
				class="pun">{</span><span class="str">"Content-Type"</span><span class="pun">:</span><span
				class="pln"> </span><span class="str">"text/plain"</span><span class="pun">});</span><span
				class="pln"><br>&nbsp; response</span><span class="pun">.</span><span class="pln">write</span><span
				class="pun">(</span><span class="str">"Hello World"</span><span class="pun">);</span><span
				class="pln"><br>&nbsp; response</span><span class="pun">.</span><span class="pln">end</span><span
				class="pun">();</span><span class="pln"><br></span><span class="pun">}).</span><span
				class="pln">listen</span><span class="pun">(</span><span class="lit">8888</span><span
				class="pun">);</span></pre>
				
		<p>
			И всё!
			Вы написали работающий HTTP-сервер.
			Давайте проверим его, запустив и протестировав.
			Во-первых, выполните ваш скрипт в Node.js:
		</p>
		
		<pre>node server.js</pre>
		
		<p>
			Теперь откройте ваш браузер и перейдите по адресу <a href="http://localhost:8888/" rel="nofollow">http://localhost:8888/</a>.
			Должна вывестись веб-страница со строкой «Hello world».
		</p>
		<p>
			Правда, это довольно интересно?
			Как насчёт того, чтобы поговорить о том, что здесь происходит и оставить на потом вопрос о том, как организовать наш проект?
			Я обещаю, мы вернемся к нему.
		</p>

		<a name="analyzing-our-http-server"></a>
		
		<h3>Анализ нашего HTTP-сервера</h3>
		
		<p>
			Хорошо, тогда давайте проанализируем, что здесь действительно происходит.
		</p>
		<p>
			Первая строчка подключает http-модуль, который поставляется вместе с Node.js и делает его доступным через переменную <em>http</em>.
		</p>
		<p>
			Далее, мы вызываем одну из функций http-модуля <em>createServer</em>.
			Эта функция возвращает объект, имеющий метод <em>listen</em>, принимающий числовое значение порта нашего HTTP-сервера, который необходимо прослушивать.

		</p>
		<p>
			Пожалуйста, проигнорируйте функцию, которая определяется внутри скобок <em>http.createServer</em>.
		</p>
		<p>
			Мы могли бы написать код, который запускает наш сервер, прослушивающий порт 8888, так:
		</p>
		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> http </span><span
				class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span
				class="str">"http"</span><span class="pun">);</span><span class="pln"><br><br></span><span class="kwd">var</span><span
				class="pln"> server </span><span class="pun">=</span><span class="pln"> http</span><span
				class="pun">.</span><span class="pln">createServer</span><span class="pun">();</span><span
				class="pln"><br>server</span><span class="pun">.</span><span class="pln">listen</span><span class="pun">(</span><span
				class="lit">8888</span><span class="pun">);</span></pre>
		<p>
			Это запустило бы HTTP-сервер прослушивающего порт 8888, который больше ничего не делает (даже не отвечает на входящие запросы).
		</p>
		<p>
			Действительно интересная (и, если вы привыкли к более консервативным языкам как PHP, довольно странная) часть &mdash; это определение функции там, где вы бы ожидали увидеть первый параметр для <em>createServer()</em>.
		</p>
		<p>
			Оказывается, эта определяемая функции и есть первый (и только) параметр, который мы передаём в <em>createServer()</em> при вызове.
			Потому что в JavaScript функции могут быть переданы как параметр в другую функцию.
		</p>
		
		<a name="passing-functions-around"></a>
		
		<h3>Передача функций в качестве параметра</h3>
		
		<p>
			Вы можете в качестве примера сделать что-то подобное:
		</p>
		
		<pre class="prettyprint lang-js"><span class="kwd">function</span><span class="pln"> say</span><span
				class="pun">(</span><span class="pln">word</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span
				class="pln">word</span><span class="pun">);</span><span class="pln"><br></span><span
				class="pun">}</span><span class="pln"><br><br></span><span class="kwd">function</span><span class="pln"> execute</span><span
				class="pun">(</span><span class="pln">someFunction</span><span class="pun">,</span><span class="pln"> value</span><span
				class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; someFunction</span><span
				class="pun">(</span><span class="pln">value</span><span class="pun">);</span><span
				class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br>execute</span><span
				class="pun">(</span><span class="pln">say</span><span class="pun">,</span><span
				class="pln"> </span><span class="str">"Hello"</span><span class="pun">);</span></pre>
				
		<p>
			Разберите пример внимательно! Здесь мы передаём функцию <em>say</em> как первый параметр функции <em>execute</em>.
			Не значение, которое возвращает функция <em>say</em>, а саму функцию <em>say</em>!
		</p>
		<p>
			Таким образом, <em>say</em> становится локальной переменной <em>someFunction</em> внутри <em>execute</em> и <em>execute</em> может вызвать функцию в этой переменной вот так: <em>someFunction()</em> (то есть, добавив скобки).
		</p>
		<p>
			Конечно же, так как <em>say</em> принимает один параметр (word), <em>execute</em> может передать какое-либо значение в качестве этого параметра, когда вызывает <em>someFunction</em>.
		</p>
		<p>
			Мы можем, что мы и сделали, передать функцию как параметр в другую функцию.
			Но мы не обязаны применять этот косвенный способ, когда сначала определяется функция, а потом передаётся как параметр.
			Мы можем определить и передать функцию как параметр в другую функцию прямо на месте:
		</p>
		
		<pre class="prettyprint lang-js"><span class="kwd">function</span><span class="pln"> execute</span><span
				class="pun">(</span><span class="pln">someFunction</span><span class="pun">,</span><span class="pln"> value</span><span
				class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; someFunction</span><span
				class="pun">(</span><span class="pln">value</span><span class="pun">);</span><span
				class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br>execute</span><span
				class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span
				class="pln">word</span><span class="pun">){</span><span class="pln"> console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span
				class="pln">word</span><span class="pun">)</span><span class="pln"> </span><span
				class="pun">},</span><span class="pln"> </span><span class="str">"Hello"</span><span
				class="pun">);</span></pre>
				
		<p>
			Мы определяем функцию, которую хотим передать в <em>execute</em>, прямо там, где у <em>execute</em> должен быть первый параметр.
		</p>
		<p>
			Из-за того, что нам даже не надо давать имя этой функции, её называют <em>анонимная функция</em>.
		</p>
		<p>
			Это первый проблеск, который я называю «продвинутый» JavaScript, но давайте всё по порядку.
			А сейчас давайте просто примем то, что в JavaScript мы можем передать функцию как параметр, когда вызываем другую функцию.
			Мы можем сделать это путём присвоения нашей функции переменной, которую му передаем, или путём определения функции для передачи на месте.
		</p>

		<a name="how-function-passing-makes-our-http-server-work"></a>

		<h3>Как анонимная функция делает наш HTTP-сервер рабочим</h3>
		
		<p>
			С этими знаниями давайте вернемся назад к нашему минималистичному HTTP-серверу:
		</p>
		
		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> http </span><span
				class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span
				class="str">"http"</span><span class="pun">);</span><span class="pln"><br><br>http</span><span
				class="pun">.</span><span class="pln">createServer</span><span class="pun">(</span><span class="kwd">function</span><span
				class="pun">(</span><span class="pln">request</span><span class="pun">,</span><span class="pln"> response</span><span
				class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; response</span><span
				class="pun">.</span><span class="pln">writeHead</span><span class="pun">(</span><span
				class="lit">200</span><span class="pun">,</span><span class="pln"> </span><span
				class="pun">{</span><span class="str">"Content-Type"</span><span class="pun">:</span><span
				class="pln"> </span><span class="str">"text/plain"</span><span class="pun">});</span><span
				class="pln"><br>&nbsp; response</span><span class="pun">.</span><span class="pln">write</span><span
				class="pun">(</span><span class="str">"Hello World"</span><span class="pun">);</span><span
				class="pln"><br>&nbsp; response</span><span class="pun">.</span><span class="pln">end</span><span
				class="pun">();</span><span class="pln"><br></span><span class="pun">}).</span><span
				class="pln">listen</span><span class="pun">(</span><span class="lit">8888</span><span
				class="pun">);</span></pre>
				
		<p>
			Сейчас должно быть ясно, что мы здесь делаем: передаём в функцию <em>createServer</em> анонимную функцию.
		</p>
		<p>
			Мы можем добиться того же самого через рефакторинг нашего кода:
		</p>

		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> http </span><span
				class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span
				class="str">"http"</span><span class="pun">);</span><span class="pln"><br><br></span><span class="kwd">function</span><span
				class="pln"> onRequest</span><span class="pun">(</span><span class="pln">request</span><span
				class="pun">,</span><span class="pln"> response</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; response</span><span
				class="pun">.</span><span class="pln">writeHead</span><span class="pun">(</span><span
				class="lit">200</span><span class="pun">,</span><span class="pln"> </span><span
				class="pun">{</span><span class="str">"Content-Type"</span><span class="pun">:</span><span
				class="pln"> </span><span class="str">"text/plain"</span><span class="pun">});</span><span
				class="pln"><br>&nbsp; response</span><span class="pun">.</span><span class="pln">write</span><span
				class="pun">(</span><span class="str">"Hello World"</span><span class="pun">);</span><span
				class="pln"><br>&nbsp; response</span><span class="pun">.</span><span class="pln">end</span><span
				class="pun">();</span><span class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br>http</span><span
				class="pun">.</span><span class="pln">createServer</span><span class="pun">(</span><span class="pln">onRequest</span><span
				class="pun">).</span><span class="pln">listen</span><span class="pun">(</span><span
				class="lit">8888</span><span class="pun">);</span></pre>
				
		<p>
			Может сейчас самое время спросить: Почему мы это делаем так?
		</p>

		<a name="event-driven-callbacks"></a>
		
		<h3>Событийно-ориентированные обратные вызовы</h3>
		
		<p>
			Ответ на вопрос a) не так легко дать (по крайней мере для меня), и b) кроется в самой природе работы Node.js — это событийно-ориентированность, то, благодаря чему он работает так быстро.
		</p>
		<p>
			Возможно, вы захотите занять немного своего времени и почитать отличный пост Felix Geisendörfer <a href="http://debuggable.com/posts/understanding-node-js:4bd98440-45e4-4a9a-8ef7-0f7ecbdd56cb">Понимание node.js</a>, чтобы прояснить этот момент.
		</p>
		<p>
			Все сводится к тому факту, что Node.js работает событийно-ориентированно.
			Ах да, я тоже до конца не понимаю, что это значит.
			Но я постараюсь объяснить, почему это так важно для тех, кто хочет писать веб-приложения в Node.js.
		</p>
		<p>
			Когда вызываем метод <em>http.createServer</em>, мы, конечно, не только хотим иметь сервер, слушающий какой-то порт.
			Мы также хотим что-нибудь сделать, когда приходит HTTP-запрос на этот сервер.
		</p>
		<p>
			Проблема состоит в асинхронности: запрос происходит в любой момент времени, в то время как у нас только один процесс, в котором запущен наш сервер.
		</p>
		<p>
			Когда пишем PHP-приложения, мы не беспокоимся обо всем этом: всякий раз, когда приходит HTTP-запрос, веб-сервер (обычно Apache) ответвляет новый процесс специально для этого запроса и запускает соответствующий PHP-скрипт с нуля, который выполняется от начала до конца.
		</p>
		<p>
			Когда приходит новый запрос на порт 8888, относительно потоков управления, мы находимся в середине нашей Node.js-программы.
			Как это понять, чтоб не помешаться?
		</p>
		<p>
			Это как раз то, где событийно-ориентированный дизайн Node.js/JavaScript на самом деле помогает. Нам надо узнать некоторые новые понятия, чтобы досконально понять всё это.
		</p>
		<p>
			Мы создаем сервер и передаём функцию в созданный им метод.
			Всякий раз, когда наш сервер получает запрос, переданная нами функция будет вызываться.
		</p>
		<p>
			Мы не знаем, когда это произойдет, но у нас теперь есть место, где можем обрабатывать входящий запрос.
			Это наша переданная функция и не имеет значения, определили ли мы её сначала или передали анонимно.
		</p>
		<p>
			Этот принцип называется <em>обратный вызов</em> или <em>callback</em>.
			Мы передаём в некоторый метод функцию и этот метод исполняет её, когда происходит связанное с методом событие.
		</p>
		<p>
			По крайней мере для меня, это заняло некоторое время, чтобы понять.
			Просто почитайте блог Felix Geisendörfer снова, если вы всё ещё не уверены.
		</p>
		<p>
			Давайте немного поиграем с этим новым понятием.
			Можем ли мы доказать, что наш код продолжает работать после создания сервера, даже если нет HTTP-запроса и callback-функция, переданная нами, не вызывается?
			Давайте попробуем:
		</p>

		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> http </span><span
				class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span
				class="str">"http"</span><span class="pun">);</span><span class="pln"><br><br></span><span class="kwd">function</span><span
				class="pln"> onRequest</span><span class="pun">(</span><span class="pln">request</span><span
				class="pun">,</span><span class="pln"> response</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request received."</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; response</span><span class="pun">.</span><span
				class="pln">writeHead</span><span class="pun">(</span><span class="lit">200</span><span
				class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span
				class="str">"Content-Type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"text/plain"</span><span
				class="pun">});</span><span class="pln"><br>&nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="str">"Hello World"</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; response</span><span class="pun">.</span><span
				class="pln">end</span><span class="pun">();</span><span class="pln"><br></span><span
				class="pun">}</span><span class="pln"><br><br>http</span><span class="pun">.</span><span class="pln">createServer</span><span
				class="pun">(</span><span class="pln">onRequest</span><span class="pun">).</span><span class="pln">listen</span><span
				class="pun">(</span><span class="lit">8888</span><span class="pun">);</span><span class="pln"><br><br>console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Server has started."</span><span
				class="pun">);</span></pre>
				
		<p>
			Обратите внимание, что я использую <em>console.log</em> для вывода текста «Request received.», когда срабатывает функция <em>onRequest</em> (наш callback), а текст «Server has started.» &mdash; сразу <em>после</em> запуска HTTP-сервера.
		</p>
		<p>
			Когда мы запустим этот код (как обычно, <em>node server.js</em>), он тут же выведет в командной строке «Server has started.».
			Всякий раз, когда мы делаем запрос нашему серверу (через переход по адресу <a href="http://localhost:8888/" rel="nofollow">http://localhost:8888/</a> в нашем браузере), в командной строке выводится сообщение «Request received.».
		</p>
		<p>
			Объектно-ориентированный асинхронный серверный JavaScript с callback-ми в действии :-)
		</p>
		<p>
			(Обратите внимание, что наш сервер, возможно, будет выводить «Request received.» в консоль 2 раза при открытии страницы в браузере.
			Это происходит из-за того, что большинство браузеров будут пытаться загрузить фавикон по адресу http://localhost:8888/favicon.ico при запросе http://localhost:8888/)
		</p>

		<a name="how-our-server-handles-requests"></a>
		
		<h3>Как наш сервер обрабатывает запросы</h3>
		
		<p>
			Хорошо, давайте быстро проанализируем остальной код сервера внутри тела нашей callback-функции <em>onRequest()</em>.
		</p>
		<p>
			Когда callback запускается и наша функция <em>onRequest()</em> срабатывает, в неё передаются 2 параметра: <em>request</em> и <em>response</em>.
		</p>
		<p>
			Они являются объектами и вы можете использовать их методы для обработки пришедшего HTTP-запроса и ответа на запрос (то есть, просто что-то посылать по проводам обратно в браузер, который запрашивал ваш сервер).
		</p>
		<p>
			И наш код делает именно это: Всякий раз, когда запрос получен, он использует функцию <em>response.writeHead()</em> для отправки HTTP-статуса 200 и Content-Type в заголовке HTTP-ответа, а функцию <em>Response.Write()</em> для отправки текста «Hello World» в теле HTTP-ответа.
		</p>
		<p>
			И последнее, мы вызываем <em>response.end()</em> чтобы завершить наш ответ.
		</p>
		<p>
			На данный момент, мы не заботимся о деталях запроса, поэтому мы не используем объект <em>request</em> полностью.
		</p>

		<a name="finding-a-place-for-our-server-module"></a>
		
		<h3>Выбор места для нашего серверного модуля</h3>
		
		<p>
			Я обещал, что мы вернёмся к организации нашего приложения.
			У нас есть код очень простого HTTP-сервера в файле <em>server.js</em> и я упоминал, что общепринято иметь главный файл с названием <em>index.js</em>, который используется для начальной загрузки и запуска нашего приложения, путём использования других модулей приложения (таких как наш модуль HTTP-сервера в <em>server.js</em>).
		</p>
		<p>
			Давайте поговорим о том, как сделать server.js настоящим Node.js-модулем, чтобы его можно было использовать в нашем главном файле <em>index.js</em>.
		</p>
		<p>
			Как вы могли заметить, мы уже использовали модули в нашем коде:
		</p>
		
		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> http </span><span
				class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span
				class="str">"http"</span><span class="pun">);</span><span class="pln"><br><br></span><span class="pun">...</span><span
				class="pln"><br><br>http</span><span class="pun">.</span><span class="pln">createServer</span><span
				class="pun">(...);</span></pre>
				
		<p>
			Где-то внутри Node.js живёт модуль под названием «http» и мы можем использовать его в нашем коде, путём подключения и присвоения его результата локальной переменной.
		</p>
		<p>
			Это делает нашу локальную переменную объектом, содержащим в себе все публичные методы модуля <em>http</em>.
		</p>
		<p>
			Общепринитая практика &mdash; использовать имя модуля для имени локальной переменной, но мы свободны в своём выборе делать, как нам нравится:
		</p>
		
		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> foo </span><span
				class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span
				class="str">"http"</span><span class="pun">);</span><span class="pln"><br><br></span><span class="pun">...</span><span
				class="pln"><br><br>foo</span><span class="pun">.</span><span class="pln">createServer</span><span
				class="pun">(...);</span></pre>
				
		<p>
			Теперь понятно, как использовать внутренние модули Node.js.
			А как создать свой собственный модуль и как его использовать?
		</p>
		<p>
			Давайте выясним это, превратив наш скрипт <em>server.js</em> в настоящий модуль.
		</p>
		<p>
			Оказывается, нам не надо менять слишком многое.
			Создание модуля означает, что нам нужно <em>экспортировать</em> какую-либо функциональность этого модуля в скрипт, который его вызывает.
		</p>
		<p>
			Сейчас функционал нашего HTTP-сервера надо экспортировать, что довольно просто: скрипты, подключающие наш модуль сервера, просто запускают сервер. 
		</p>
		<p>
			Чтобы сделать это возможным, поместим код нашего сервера в функцию под название <em>start</em> и будем экспортировать эту функцию:
		</p>
		
		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> http </span><span
				class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span
				class="str">"http"</span><span class="pun">);</span><span class="pln"><br><br></span><span class="kwd">function</span><span
				class="pln"> start</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span
				class="pln"><br>&nbsp; </span><span class="kwd">function</span><span class="pln"> onRequest</span><span
				class="pun">(</span><span class="pln">request</span><span class="pun">,</span><span class="pln"> response</span><span
				class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request received."</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">writeHead</span><span class="pun">(</span><span class="lit">200</span><span
				class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span
				class="str">"Content-Type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"text/plain"</span><span
				class="pun">});</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="str">"Hello World"</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">end</span><span class="pun">();</span><span class="pln"><br>&nbsp; </span><span class="pun">}</span><span
				class="pln"><br><br>&nbsp; http</span><span class="pun">.</span><span
				class="pln">createServer</span><span class="pun">(</span><span class="pln">onRequest</span><span
				class="pun">).</span><span class="pln">listen</span><span class="pun">(</span><span
				class="lit">8888</span><span class="pun">);</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Server has started."</span><span
				class="pun">);</span><span class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br>exports</span><span
				class="pun">.</span><span class="pln">start </span><span class="pun">=</span><span
				class="pln"> start</span><span class="pun">;</span></pre>
				
		<p>
			Теперь мы можем создать наш основной файл <em>index.js</em>, и запускать наш HTTP-сервер там, хотя код для сервера находится всё ещё в файле <em>server.js</em>.
		</p>
		<p>
			Создаём файл <em>index.js</em> со следующим содержимым:
		</p>
		
		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> server </span><span class="pun">=</span><span
				class="pln"> require</span><span class="pun">(</span><span class="str">"./server"</span><span
				class="pun">);</span><span class="pln"><br><br>server</span><span class="pun">.</span><span class="pln">start</span><span
				class="pun">();</span></pre>
				
		<p>
			Как вы могли видеть, мы можем использовать модуль сервера просто как внешний модуль: вызвав этот файл и определив для него переменную, экспортированные функции становятся доступны нам.
		</p>
		<p>
			Вот и всё. Сейчас мы можем запустить наше приложение через главный скрипт и он будет делать всё то же самое, что и раньше:
		</p>
<pre>node index.js</pre>
		<p>
			Великолепно &mdash; сейчас мы можем помещать различные части нашего приложения в разные файлы и связывать их вместе, посредством превращения их в модули.
		</p>
		<p>
			До сих пор мы работали только с первой частью нашего приложения: получение HTTP-запроса.
			Но нам надо что-нибудь с ним делать. 
			В зависимости от URL, запрошенного браузером у нашего сервера, мы должны реагировать по-разному.
		</p>
		<p>
			В очень простом приложении мы могли бы делать это напрямую внутри callback-функции <em>onRequest()</em>.
			Но, как я говорил, давайте добавим немного больше абстракции, чтобы сделать наш пример интереснее.
		</p>
		<p>
			Задание соответствия между разными HTTP-запросами и разными частями нашего кода называется «маршрутизация» («routing», роутинг).
			Давайте тогда создадим модуль под названием <em>router</em>.
		</p>

		<a name="whats-needed-to-route-requests"></a>
		
		<h3>Что необходимо для «роутера»?</h3>
		
		<p>
			Нам нужно иметь возможность скармливать запрошенный URL и возможные добавочные GET- и POST-параметры нашему роутеру и, с учётом этого, роутер должен определять, какой код выполнять (этот код есть третья составляющая нашего приложения: коллекция обработчиков запросов, делающие необходимую работу по определённому запросу).
		</p>
		<p>
			Итак, нам надо рассматривать HTTP-запрос и извлекать запрошенный URL, а также GET/POST-параметры.
			Можно поспорить, должен ли этот код быть частью роутера или сервера (или даже своего собственного модуля), но давайте сейчас пока просто сделаем его частью сервера.
		</p>
		<p>
			Вся необходимая нам информация доступна через объект <em>request</em>, который передается в качестве первого параметра нашей callback-функции <em>onRequest()</em>.
			Чтобы интерпретировать эту информацию, нам необходимо добавить кое-какие Node.js-модули, а именно <em>url</em> и <em>querystring</em>.
		</p>
		<p>
			Модуль <em>url</em> поддерживает методы, которые позволяют нам извлекать различные части URL (такие как запрошенный путь (URL path) и строка параметров запроса (query string)), а <em>querystring</em> в свою очередь, используется для парсинга строки параметров запроса (query string):
		</p>
<pre>                               url.parse(string).query
                                       |
       url.parse(string).pathname      |
                   |                   |
                   |                   |
                 ------ -------------------
http://localhost:8888/start?foo=bar&amp;hello=world
                            ---       -----
                             |          |
                             |          |
          querystring(string)["foo"]    |
                                        |
                     querystring(string)["hello"]
</pre>
		<p>
			Конечно, мы также можем использовать <em>querystring</em> для парсинга тела POST-запроса, как мы увидим далее.
		</p>
		<p>
			Давайте сейчас добавим в нашу функцию <em>onRequest()</em> логику, необходимую для извлечения пути URL (pathname), запрошенного браузером:
		</p>
		
		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> http </span><span
				class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span
				class="str">"http"</span><span class="pun">);</span><span class="pln"><br></span><span
				class="kwd">var</span><span class="pln"> url </span><span class="pun">=</span><span
				class="pln"> require</span><span class="pun">(</span><span class="str">"url"</span><span
				class="pun">);</span><span class="pln"><br><br></span><span class="kwd">function</span><span
				class="pln"> start</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span
				class="pln"><br>&nbsp; </span><span class="kwd">function</span><span class="pln"> onRequest</span><span
				class="pun">(</span><span class="pln">request</span><span class="pun">,</span><span class="pln"> response</span><span
				class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="kwd">var</span><span class="pln"> pathname </span><span class="pun">=</span><span class="pln"> url</span><span
				class="pun">.</span><span class="pln">parse</span><span class="pun">(</span><span
				class="pln">request</span><span class="pun">.</span><span class="pln">url</span><span
				class="pun">).</span><span class="pln">pathname</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request for "</span><span
				class="pln"> </span><span class="pun">+</span><span class="pln"> pathname </span><span
				class="pun">+</span><span class="pln"> </span><span class="str">" received."</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">writeHead</span><span class="pun">(</span><span class="lit">200</span><span
				class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span
				class="str">"Content-Type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"text/plain"</span><span
				class="pun">});</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="str">"Hello World"</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">end</span><span class="pun">();</span><span class="pln"><br>&nbsp; </span><span class="pun">}</span><span
				class="pln"><br><br>&nbsp; http</span><span class="pun">.</span><span
				class="pln">createServer</span><span class="pun">(</span><span class="pln">onRequest</span><span
				class="pun">).</span><span class="pln">listen</span><span class="pun">(</span><span
				class="lit">8888</span><span class="pun">);</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Server has started."</span><span
				class="pun">);</span><span class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br>exports</span><span
				class="pun">.</span><span class="pln">start </span><span class="pun">=</span><span
				class="pln"> start</span><span class="pun">;</span></pre>
				
		<p>
			Замечательно. 
			Теперь наше приложение может различать запросы на основе запрошенного пути URL.
			Это позволяет нам направлять запросы нашим обработчикам запросов в зависимости от пути URL, используя наш роутер.
			Таким образом, мы можем строить наше приложение RESTful-путём, потому что теперь можем реализовать интерфейс, следующий принципам <em>Идентификации ресурсов</em> (смотри статью в википедии <a href="http://ru.wikipedia.org/wiki/REST">REST</a> для справки).
			
		</p>
		<p>
			В контексте нашего приложения, это означает, что мы сможем обрабатывать запросы с URL <em>/start</em> и <em>/upload</em> разными частями нашего кода. 
			Скоро мы увидим, как всё соединяется вместе.
		</p>
		<p>
			Теперь самое время написать наш роутер. 
			Создаём новый файл под названием <em>router.js</em> со следующим содержимым:
		</p>

		<pre class="prettyprint lang-js"><span class="kwd">function</span><span class="pln"> route</span><span
				class="pun">(</span><span class="pln">pathname</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"About to route a request for "</span><span
				class="pln"> </span><span class="pun">+</span><span class="pln"> pathname</span><span
				class="pun">);</span><span class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br>exports</span><span
				class="pun">.</span><span class="pln">route </span><span class="pun">=</span><span
				class="pln"> route</span><span class="pun">;</span></pre>

		<p>
			Конечно этот код ничего не делает, но сейчас этого достаточно.
			Давайте сначала посмотрим, как скрепить этот роутер с нашим сервером до того как поместим больше логики в роутер.
		</p>
		<p>
			Нашему HTTP-серверу необходимо знать о роутере и использовать его.
			Мы могли бы жёстко прописать эти зависимости в нашем сервере, но, так как мы знаем только сложные способы из нашего опыта в других языках программирования, мы сделаем слабосвязанную зависимость сервера и роутера через внедрение этих зависимостей (можете почитать <a href="http://martinfowler.com/articles/injection.html">отличный пост Мартина Фаулера по внедрениям зависимости на английском языке</a> или <a href="http://ru.wikipedia.org/wiki/%D0%92%D0%BD%D0%B5%D0%B4%D1%80%D0%B5%D0%BD%D0%B8%D0%B5_%D0%B7%D0%B0%D0%B2%D0%B8%D1%81%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D0%B8">статью в Википедии на русском языке</a> для дополнительной информации).
		</p>
		<p>
			Для начала, расширим нашу серверную функцию <em>start()</em>, чтобы дать нам возможность передавать функцию <em>route()</em> как параметр:
		</p>

		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> http </span><span
				class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span
				class="str">"http"</span><span class="pun">);</span><span class="pln"><br></span><span
				class="kwd">var</span><span class="pln"> url </span><span class="pun">=</span><span
				class="pln"> require</span><span class="pun">(</span><span class="str">"url"</span><span
				class="pun">);</span><span class="pln"><br><br></span><span class="kwd">function</span><span
				class="pln"> start</span><span class="pun">(</span><span class="pln">route</span><span
				class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span
				class="pln"><br>&nbsp; </span><span class="kwd">function</span><span class="pln"> onRequest</span><span
				class="pun">(</span><span class="pln">request</span><span class="pun">,</span><span class="pln"> response</span><span
				class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="kwd">var</span><span class="pln"> pathname </span><span class="pun">=</span><span class="pln"> url</span><span
				class="pun">.</span><span class="pln">parse</span><span class="pun">(</span><span
				class="pln">request</span><span class="pun">.</span><span class="pln">url</span><span
				class="pun">).</span><span class="pln">pathname</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request for "</span><span
				class="pln"> </span><span class="pun">+</span><span class="pln"> pathname </span><span
				class="pun">+</span><span class="pln"> </span><span class="str">" received."</span><span
				class="pun">);</span><span class="pln"><br><br>&nbsp; &nbsp; route</span><span class="pun">(</span><span
				class="pln">pathname</span><span class="pun">);</span><span
				class="pln"><br><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">writeHead</span><span class="pun">(</span><span class="lit">200</span><span
				class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span
				class="str">"Content-Type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"text/plain"</span><span
				class="pun">});</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="str">"Hello World"</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">end</span><span class="pun">();</span><span class="pln"><br>&nbsp; </span><span class="pun">}</span><span
				class="pln"><br><br>&nbsp; http</span><span class="pun">.</span><span
				class="pln">createServer</span><span class="pun">(</span><span class="pln">onRequest</span><span
				class="pun">).</span><span class="pln">listen</span><span class="pun">(</span><span
				class="lit">8888</span><span class="pun">);</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Server has started."</span><span
				class="pun">);</span><span class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br>exports</span><span
				class="pun">.</span><span class="pln">start </span><span class="pun">=</span><span
				class="pln"> start</span><span class="pun">;</span></pre>
				
		<p>
			Теперь расширим наш <em>index.js</em> соответственно, то есть внедрим функцию <em>route()</em> нашего роутера в сервер:
		</p>

		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> server </span><span class="pun">=</span><span
				class="pln"> require</span><span class="pun">(</span><span class="str">"./server"</span><span
				class="pun">);</span><span class="pln"><br></span><span class="kwd">var</span><span
				class="pln"> router </span><span class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span
				class="str">"./router"</span><span class="pun">);</span><span class="pln"><br><br>server</span><span
				class="pun">.</span><span class="pln">start</span><span class="pun">(</span><span
				class="pln">router</span><span class="pun">.</span><span class="pln">route</span><span
				class="pun">);</span><span class="pln"><br></span></pre>
				
		<p>
			Мы опять передаём функцию, которая не является чем-то новым для нас.
		</p>
		<p>
			Если мы сейчас запустим наше приложение (<em>node index.js, как обычно</em>) и запросим какой-нибудь URL, вы сможете увидеть в консоли, что наш HTTP-сервер использует наш роутер и передает ему запрошенный pathname:
		</p>

		<pre>bash$ node index.js
Request for /foo received.
About to route a request for /foo</pre>

		<p>
			(Я опустил слегка надоедливый вывод для запроса /favicon.ico)
		</p>

		<a name="execution-in-the-kongdom-of-verbs"></a>
		
		<h3>Исполнение королевских постановлений в царстве глаголов</h3>
		
		<p>
			Позвольте мне ещё раз побродить вокруг и около и снова поговорить о функциональном программировании.
		</p>
		<p>
			Передача функций связана не только с техническими соображениями.
			Относительно разработки программного обеспечения это &mdash; почти философия.
			Просто подумайте: в нашем index-файле мы могли бы передавать объект <em>router</em> в наш сервер и сервер мог бы вызывать функцию <em>route</em> этого объекта.
		</p>
		<p>
			Этим способом мы бы передавали <em>нечто</em> и сервер использовал бы это нечто, чтобы <em>сделать</em> что-то.
			Эй, роутер, не могли бы вы показать мне маршрут?
		</p>
		<p>
			Но серверу не нужно нечто. 
			Ему нужно только получить что-то <em>сделанное</em>, а чтоб получить уже что-то сделанное, вам не нужно нечто совсем, вам необходимо <em>действие</em>.
			Вам не нужно <em>существительное</em>, вам нужен <em>глагол</em>.
		</p>
		<p>
			Понимание фундаментальных умозаключений, которые лежат в основе этой идеи, позволило мне действительно понять функциональное программирование.
		</p>
		<p>
			Я понял это, когда читал шедевр Стива Йегге <a href="http://steve-yegge.blogspot.com/2006/03/execution-in-kingdom-of-nouns.html">Execution in the Kingdom of Nouns</a> (частичный перевод на русский <a href="http://ru-declarative.livejournal.com/64216.html">Исполнение королевских постановлений в царстве существительных</a>).
			Почитайте это обязательно. Это одно из лучших произведений о программировании, которое я когда-либо имел удовольствие встречать.
		</p>
		
		<a name="routing-to-real-request-handlers"></a>
		
		<h3>Роутинг реальных обработчиков запроса</h3>
		<p>
			Вернёмся к делу.
			Наш HTTP-сервер и наш роутер запросов сейчас &mdash; лучшие друзья, и общаются друг с другом так, как мы хотели.
		</p>
		<p>
			Конечно, этого недостаточно.
			«Роутинг» подразумевает, что мы хотим обрабатывать запросы на разные URL по-разному.
			Мы хотели бы иметь «бизнес-логику» для запросов к <em>/start</em> в одной функции, а для запросов к <em>/upload</em> в другой.
		</p>
		<p>
			Прямо сейчас мы закончим с нашим роутером. Роутер не место на самом деле, чтобы делать что-то с запросами, потому что будет плохо масштабироваться, а наше приложение будет становиться сложнее.
		</p>
		<p>
			Давайте эти функции, в которые направляются запросы, назовём <em>обработчиками запросов</em>.
			И давайте возьмёмся за них сейчас, потому что делать что-либо с роутером сейчас пока не имеет смысла.
		</p>
		<p>
			Новая часть приложения, новый модуль &mdash; здесь никаких сюрпризов.
			Создадим модуль под названием requestHandlers, добавим болванки функций для каждого обработчика запроса и экспортируем их как методы модуля:
		</p>
		<pre class="prettyprint lang-js"><span class="kwd">function</span><span class="pln"> start</span><span
				class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request handler 'start' was called."</span><span
				class="pun">);</span><span class="pln"><br></span><span class="pun">}</span><span
				class="pln"><br><br></span><span class="kwd">function</span><span class="pln"> upload</span><span
				class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request handler 'upload' was called."</span><span
				class="pun">);</span><span class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br>exports</span><span
				class="pun">.</span><span class="pln">start </span><span class="pun">=</span><span
				class="pln"> start</span><span class="pun">;</span><span class="pln"><br>exports</span><span
				class="pun">.</span><span class="pln">upload </span><span class="pun">=</span><span
				class="pln"> upload</span><span class="pun">;</span></pre>
		<p>
			Это позволяет нам связать обработчики запросов с роутером, давая нашему роутеру что-нибудь маршрутизировать.
		</p>
		<p>
			В этот момент мы должны принять решение: захардкодить использование модуля requestHandlers в роутере или мы хотим ещё немного внедрения зависимостей?
			Хотя внедрение зависимостей, как и любой другой паттерн, не должен использоваться только ради того, чтобы быть использованным, в нашем случае имеет смысл сделать слабосвязанную пару роутера и обработчиков запроса и, таким образом, сделать роутер действительно многоразовым.
		</p>
		<p>
			Это означает, что нам нужно передавать обработчики запросов из нашего сервера в наш роутер, но это немного неправильно, поэтому мы должны пройти весь путь и передать их в сервер из нашего главного файла, а также &mdash; оттуда передавать в роутер.
		</p>
		<p>
			Как мы собираемся передать их?
			Сейчас у нас есть два обработчика, но в реальном приложении это число будет увеличиваться и меняться.
			И мы уверены, что не хотим возиться с роутером каждый раз, когда добавляется новый URL + обработчик запроса.
			И какие-нибудь <em>if запрос == x then вызвать обработчик y</em> в роутере будут более чем убоги.
		</p>
		<p>
			Переменное число элементов и каждому соответствует строка (запрашиваемый URL)? 
			Так, похоже на ассоциативный массив, это наиболее подходящее.
		</p>
		<p>
			Это решение немного разочаровывает тем фактом, что JavaScript не поддерживает ассоциативные массивы. Или нет?
			Оказывается в действительности, если нам нужны ассоциативные массивы, мы должны использовать объекты!
		</p>
		<p>
			Об этом есть хорошее введение <a href="http://msdn.microsoft.com/en-us/magazine/cc163419.aspx">http://msdn.microsoft.com/en-us/magazine/cc163419.aspx</a>.
			Позвольте мне процитировать подходящую часть:
		</p>
		<blockquote>
			<p>
				В C++ или C#, когда мы говорим об объектах, мы ссылаемся на экземпляры классов или структуры.
				Объекты имеют разные свойства и методы, в зависимости от шаблонов (классов), экземплярами которых они являются.
				Но не в случае с JavaScript-объектами.
				В JavaScript, объекты &mdash; это просто коллекция пар имя/значение &mdash; JavaScript-объект &mdash; это как словарь со строковыми ключами.
			</p>
		</blockquote>
		<p>
			Если JavaScript-объекты это просто коллекции пар имя/значение, как тогда у них могут быть методы?
			Итак, значения могут быть строками, числами и т.д. или функциями!
		</p>
		<p>
			Хорошо, наконец-то возвращаемся к нашему коду. Мы решили, что мы хотим передать список из requestHandlers как объект и, для того, чтобы достичь слабое связывание, мы хотим внедрить этот объект в <em>route()</em>.
		</p>
		<p>
			Начнём с добавления объекта в наш главный файл <em>index.js</em>:
		</p>
<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> server </span><span class="pun">=</span><span
		class="pln"> require</span><span class="pun">(</span><span class="str">"./server"</span><span
		class="pun">);</span><span class="pln"><br></span><span class="kwd">var</span><span
		class="pln"> router </span><span class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span
		class="str">"./router"</span><span class="pun">);</span><span class="pln"><br></span><span class="kwd">var</span><span
		class="pln"> requestHandlers </span><span class="pun">=</span><span class="pln"> require</span><span
		class="pun">(</span><span class="str">"./requestHandlers"</span><span class="pun">);</span><span
		class="pln"><br><br></span><span class="kwd">var</span><span class="pln"> handle </span><span
		class="pun">=</span><span class="pln"> </span><span class="pun">{}</span><span
		class="pln"><br>handle</span><span class="pun">[</span><span class="str">"/"</span><span
		class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> requestHandlers</span><span
		class="pun">.</span><span class="pln">start</span><span class="pun">;</span><span class="pln"><br>handle</span><span
		class="pun">[</span><span class="str">"/start"</span><span class="pun">]</span><span
		class="pln"> </span><span class="pun">=</span><span class="pln"> requestHandlers</span><span
		class="pun">.</span><span class="pln">start</span><span class="pun">;</span><span class="pln"><br>handle</span><span
		class="pun">[</span><span class="str">"/upload"</span><span class="pun">]</span><span
		class="pln"> </span><span class="pun">=</span><span class="pln"> requestHandlers</span><span
		class="pun">.</span><span class="pln">upload</span><span class="pun">;</span><span class="pln"><br><br>server</span><span
		class="pun">.</span><span class="pln">start</span><span class="pun">(</span><span
		class="pln">router</span><span class="pun">.</span><span class="pln">route</span><span
		class="pun">,</span><span class="pln"> handle</span><span class="pun">);</span></pre>
		<p>
			Хотя <em>handle</em> &mdash; это больше из разряда «нечто» (коллекция обработчиков запроса), я, всё-таки, предлагаю называть его глаголом, потому что в результате это будет функциональное выражение в нашем роутере, как вы скоро увидите. 
		</p>
		<p>
			Как вы можете видеть, это действительно просто &mdash; назначать различные URL соответствующему обработчику запроса: просто добавляя пару ключ/значение из <em>«/»</em> и <em>requestHandlers.start</em>, мы можем выразить красивым и аккуратным способом, что не только запросы к <em>«/start»</em>, но также и запросы к <em>«/»</em> должны быть обработаны обработчиком <em>start</em>.
		</p>
		<p>
			После определения объекта мы передали его в сервер как дополнительный параметр.
			Изменим наш <em>server.js</em>, чтобы использовать его:
		</p>
		
		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> http </span><span
				class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span
				class="str">"http"</span><span class="pun">);</span><span class="pln"><br></span><span
				class="kwd">var</span><span class="pln"> url </span><span class="pun">=</span><span
				class="pln"> require</span><span class="pun">(</span><span class="str">"url"</span><span
				class="pun">);</span><span class="pln"><br><br></span><span class="kwd">function</span><span
				class="pln"> start</span><span class="pun">(</span><span class="pln">route</span><span
				class="pun">,</span><span class="pln"> handle</span><span class="pun">)</span><span class="pln"> </span><span
				class="pun">{</span><span class="pln"><br>&nbsp; </span><span class="kwd">function</span><span
				class="pln"> onRequest</span><span class="pun">(</span><span class="pln">request</span><span
				class="pun">,</span><span class="pln"> response</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="kwd">var</span><span class="pln"> pathname </span><span class="pun">=</span><span class="pln"> url</span><span
				class="pun">.</span><span class="pln">parse</span><span class="pun">(</span><span
				class="pln">request</span><span class="pun">.</span><span class="pln">url</span><span
				class="pun">).</span><span class="pln">pathname</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request for "</span><span
				class="pln"> </span><span class="pun">+</span><span class="pln"> pathname </span><span
				class="pun">+</span><span class="pln"> </span><span class="str">" received."</span><span
				class="pun">);</span><span class="pln"><br><br>&nbsp; &nbsp; route</span><span class="pun">(</span><span
				class="pln">handle</span><span class="pun">,</span><span class="pln"> pathname</span><span class="pun">);</span><span
				class="pln"><br><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">writeHead</span><span class="pun">(</span><span class="lit">200</span><span
				class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span
				class="str">"Content-Type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"text/plain"</span><span
				class="pun">});</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="str">"Hello World"</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">end</span><span class="pun">();</span><span class="pln"><br>&nbsp; </span><span class="pun">}</span><span
				class="pln"><br><br>&nbsp; http</span><span class="pun">.</span><span
				class="pln">createServer</span><span class="pun">(</span><span class="pln">onRequest</span><span
				class="pun">).</span><span class="pln">listen</span><span class="pun">(</span><span
				class="lit">8888</span><span class="pun">);</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Server has started."</span><span
				class="pun">);</span><span class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br>exports</span><span
				class="pun">.</span><span class="pln">start </span><span class="pun">=</span><span
				class="pln"> start</span><span class="pun">;</span></pre>
				
		<p>
			Мы добавили параметр <em>handle</em> в функцию <em>start()</em> и передаём объект handle в callback-функцию <em>route()</em> в качестве перового параметра.
		</p>
		<p>
			Соответственно, изменим функцию <em>route()</em> в нашем файле <em>router.js</em>:
		</p>

		<pre class="prettyprint lang-js"><span class="kwd">function</span><span class="pln"> route</span><span
				class="pun">(</span><span class="pln">handle</span><span class="pun">,</span><span
				class="pln"> pathname</span><span class="pun">)</span><span class="pln"> </span><span
				class="pun">{</span><span class="pln"><br>&nbsp; console</span><span class="pun">.</span><span
				class="pln">log</span><span class="pun">(</span><span class="str">"About to route a request for "</span><span
				class="pln"> </span><span class="pun">+</span><span class="pln"> pathname</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; </span><span class="kwd">if</span><span
				class="pln"> </span><span class="pun">(</span><span class="kwd">typeof</span><span
				class="pln"> handle</span><span class="pun">[</span><span class="pln">pathname</span><span
				class="pun">]</span><span class="pln"> </span><span class="pun">===</span><span
				class="pln"> </span><span class="str">'function'</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; handle</span><span
				class="pun">[</span><span class="pln">pathname</span><span class="pun">]();</span><span class="pln"><br>&nbsp; </span><span
				class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"No request handler found for "</span><span
				class="pln"> </span><span class="pun">+</span><span class="pln"> pathname</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; </span><span class="pun">}</span><span
				class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br>exports</span><span
				class="pun">.</span><span class="pln">route </span><span class="pun">=</span><span
				class="pln"> route</span><span class="pun">;</span></pre>
				
		<p>
			Что мы здесь делаем &mdash; мы проверяем, существует ли обработчик запроса для данного пути, и если существует, просто вызываем соответствующую функцию.
			Из-за того, что мы имеем доступ к нашим функциям обработчиков запроса из нашего объекта просто, как если бы имели доступ к элементу ассоциативного массива, у нас есть это прекрасное выражение <em>handle[pathname]();</em>, о котором говорилось ранее: «Пожалуйста, <em>handle</em> этот <em>pathname</em>».
		</p>
		<p>
			Хорошо, это всё, что нужно, чтобы связать сервер, роутер и обработчики запроса вместе!
			При запуске нашего приложения и запроса <a href="http://localhost:8888/start" rel="nofollow">http://localhost:8888/start</a> в браузере, мы можем убедиться, что надлежащий обработчик запроса действительно был вызван:
		</p>
<pre>Server has started.
Request for /start received.
About to route a request for /start
Request handler 'start' was called.
</pre>
		<p>
			Так же открываем <a href="http://localhost:8888/" rel="nofollow">http://localhost:8888/</a> в нашем браузере и убеждаемся, что эти запросы в самом деле обрабатываются обработчиком запросов <em>start</em>:
		</p>
<pre>Request for / received.
About to route a request for /
Request handler 'start' was called.
</pre>

		<a name="making-the-request-handlers-respond"></a>
		
		<h3>Создание ответа обработчиков запроса</h3>
		
		<p>
			Замечательно. Вот только если бы обработчики запроса могли отправлять что-нибудь назад браузеру, было бы ещё лучше, правильно?
		</p>
		<p>
			Вспомните, «Hello World», который выводит ваш браузер в запрошенной странице, всё ещё исходит от функции <em>onRequest</em> в нашем файле <em>server.js</em>.
		</p>
		<p>
			«Обработка запроса» подразумевает «ответ на запросы» в конце концов, поэтому необходимо дать возможность нашим обработчикам запроса общаться с браузером так же, как это делает функция <em>onRequest</em>.
		</p>

		<a name="how-to-not-do-it"></a>
		
		<h4>Как делать не надо</h4>
		
		<p>
			Прямой подход, который мы захотим использовать как разработчики с опытом в PHP или Ruby, на самом деле ложный: он может прекрасно работать, иметь большой смысл, а потом, когда мы этого не ждём, неожиданно всё развалится.
		</p>
		<p>
			Под «прямым подходом» я подразумеваю использование в обработчиках запроса <em>return ""</em> для контента, который надо показать пользователю, и отправлять этот ответ в функцию <em>onRequest</em> назад пользователю.
		</p>
		<p>
			Давайте просто сделаем это и тогда увидим, почему это не такая уж и хорошая идея.
		</p>
		<p>
			Мы начнём с обработчиков запроса и заставим их возвращать то, что хотели бы показать в браузере.
			Нам надо изменить <em>requestHandlers.js</em> вот так:
		</p>

		<pre class="prettyprint lang-js"><span class="kwd">function</span><span class="pln"> start</span><span
				class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request handler 'start' was called."</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; </span><span class="kwd">return</span><span
				class="pln"> </span><span class="str">"Hello Start"</span><span class="pun">;</span><span
				class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br></span><span class="kwd">function</span><span
				class="pln"> upload</span><span class="pun">()</span><span class="pln"> </span><span
				class="pun">{</span><span class="pln"><br>&nbsp; console</span><span class="pun">.</span><span
				class="pln">log</span><span class="pun">(</span><span
				class="str">"Request handler 'upload' was called."</span><span class="pun">);</span><span
				class="pln"><br>&nbsp; </span><span class="kwd">return</span><span class="pln"> </span><span
				class="str">"Hello Upload"</span><span class="pun">;</span><span class="pln"><br></span><span
				class="pun">}</span><span class="pln"><br><br>exports</span><span class="pun">.</span><span class="pln">start </span><span
				class="pun">=</span><span class="pln"> start</span><span class="pun">;</span><span class="pln"><br>exports</span><span
				class="pun">.</span><span class="pln">upload </span><span class="pun">=</span><span
				class="pln"> upload</span><span class="pun">;</span></pre>
				
		<p>
			Хорошо. Также, роутер должен вернуть серверу то, что обработчики запроса вернули ему.
			Поэтому надо отредактировать <em>router.js</em> так:
		</p>

		<pre class="prettyprint lang-js"><span class="kwd">function</span><span class="pln"> route</span><span
				class="pun">(</span><span class="pln">handle</span><span class="pun">,</span><span
				class="pln"> pathname</span><span class="pun">)</span><span class="pln"> </span><span
				class="pun">{</span><span class="pln"><br>&nbsp; console</span><span class="pun">.</span><span
				class="pln">log</span><span class="pun">(</span><span class="str">"About to route a request for "</span><span
				class="pln"> </span><span class="pun">+</span><span class="pln"> pathname</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; </span><span class="kwd">if</span><span
				class="pln"> </span><span class="pun">(</span><span class="kwd">typeof</span><span
				class="pln"> handle</span><span class="pun">[</span><span class="pln">pathname</span><span
				class="pun">]</span><span class="pln"> </span><span class="pun">===</span><span
				class="pln"> </span><span class="str">'function'</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="kwd">return</span><span class="pln"> handle</span><span class="pun">[</span><span class="pln">pathname</span><span
				class="pun">]();</span><span class="pln"><br>&nbsp; </span><span class="pun">}</span><span
				class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span
				class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; console</span><span class="pun">.</span><span
				class="pln">log</span><span class="pun">(</span><span class="str">"No request handler found for "</span><span
				class="pln"> </span><span class="pun">+</span><span class="pln"> pathname</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">return</span><span
				class="pln"> </span><span class="str">"404 Not found"</span><span class="pun">;</span><span class="pln"><br>&nbsp; </span><span
				class="pun">}</span><span class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br>exports</span><span
				class="pun">.</span><span class="pln">route </span><span class="pun">=</span><span
				class="pln"> route</span><span class="pun">;</span></pre>
				
		<p>
			Как видим, возвращается некоторый текст «404 Not found», если запрос не может быть маршрутизирован.
		</p>
		<p>
			И самое последнее, но не менее важное, нам нужен рефакторинг нашего сервера, чтобы заставить его отвечать браузеру с контентом обработчиков запроса, возвращаемых через роутер. Трансформируем <em>server.js</em> в:
		</p>

		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> http </span><span
				class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span
				class="str">"http"</span><span class="pun">);</span><span class="pln"><br></span><span
				class="kwd">var</span><span class="pln"> url </span><span class="pun">=</span><span
				class="pln"> require</span><span class="pun">(</span><span class="str">"url"</span><span
				class="pun">);</span><span class="pln"><br><br></span><span class="kwd">function</span><span
				class="pln"> start</span><span class="pun">(</span><span class="pln">route</span><span
				class="pun">,</span><span class="pln"> handle</span><span class="pun">)</span><span class="pln"> </span><span
				class="pun">{</span><span class="pln"><br>&nbsp; </span><span class="kwd">function</span><span
				class="pln"> onRequest</span><span class="pun">(</span><span class="pln">request</span><span
				class="pun">,</span><span class="pln"> response</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="kwd">var</span><span class="pln"> pathname </span><span class="pun">=</span><span class="pln"> url</span><span
				class="pun">.</span><span class="pln">parse</span><span class="pun">(</span><span
				class="pln">request</span><span class="pun">.</span><span class="pln">url</span><span
				class="pun">).</span><span class="pln">pathname</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request for "</span><span
				class="pln"> </span><span class="pun">+</span><span class="pln"> pathname </span><span
				class="pun">+</span><span class="pln"> </span><span class="str">" received."</span><span
				class="pun">);</span><span class="pln"><br><br>&nbsp; &nbsp; response</span><span
				class="pun">.</span><span class="pln">writeHead</span><span class="pun">(</span><span
				class="lit">200</span><span class="pun">,</span><span class="pln"> </span><span
				class="pun">{</span><span class="str">"Content-Type"</span><span class="pun">:</span><span
				class="pln"> </span><span class="str">"text/plain"</span><span class="pun">});</span><span
				class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> content </span><span
				class="pun">=</span><span class="pln"> route</span><span class="pun">(</span><span
				class="pln">handle</span><span class="pun">,</span><span class="pln"> pathname</span><span
				class="pun">)</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="pln">content</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">end</span><span class="pun">();</span><span class="pln"><br>&nbsp; </span><span class="pun">}</span><span
				class="pln"><br><br>&nbsp; http</span><span class="pun">.</span><span
				class="pln">createServer</span><span class="pun">(</span><span class="pln">onRequest</span><span
				class="pun">).</span><span class="pln">listen</span><span class="pun">(</span><span
				class="lit">8888</span><span class="pun">);</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Server has started."</span><span
				class="pun">);</span><span class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br>exports</span><span
				class="pun">.</span><span class="pln">start </span><span class="pun">=</span><span
				class="pln"> start</span><span class="pun">;</span></pre>
				
		<p>
			Если запустим наше написаное приложение, всё будет работать замечательно: запрос <a href="http://localhost:8888/start" rel="nofollow">http://localhost:8888/start</a> выдаст в браузере результат «Hello Start», запрос <a href="http://localhost:8888/upload" rel="nofollow">http://localhost:8888/upload</a> даст нам «Hello Upload», а <a href="http://localhost:8888/foo" rel="nofollow">http://localhost:8888/foo</a> выведет «404 Not found».
		</p>
		<p>
			OK, тогда в чём проблема?
			Короткий ответ: потому что мы столкнемся с проблемами, если один из обработчиков запроса захочет использовать неблокирующую операцию в будущем.
		</p>
		<p>
			Подробный ответ займёт немного больше времени.
		</p>
		
		<a name="blocking-and-non-blocking"></a>
		
		<h4>Блокирование и неблокирование</h4>
		
		<p>
			Как было сказано, проблемы будут возникать, когда мы добавим неблокирующие операции в обработчики запроса.
			Давайте сначала поговорим о блокирующих, а потом уже о неблокирующих операциях.				
		</p>
		<p>
			Вместо того, чтобы объяснять, что такое «блокирование» и «неблокирование», давайте продемонстрируем себе, что произойдёт, если мы добавим блокирующую операцию в наши обработчики запроса.
		</p>
		<p>
			Для этого модифицируем обработчик запроса <em>start</em> так, чтобы он ждал 10 секунд до того как вернёт свою строку «Hello Start».
			В JavaScript нет такой штуки как <em>sleep()</em>, поэтому мы будем использовать хитрый хак.
		</p>
		<p>
			Пожалуйста, измените <em>requestHandlers.js</em> как описано далее:
		</p>

		<pre class="prettyprint lang-js"><span class="kwd">function</span><span class="pln"> start</span><span
				class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request handler 'start' was called."</span><span
				class="pun">);</span><span class="pln"><br><br>&nbsp; </span><span class="kwd">function</span><span
				class="pln"> sleep</span><span class="pun">(</span><span class="pln">milliSeconds</span><span
				class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="kwd">var</span><span class="pln"> startTime </span><span class="pun">=</span><span
				class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span
				class="typ">Date</span><span class="pun">().</span><span class="pln">getTime</span><span
				class="pun">();</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">while</span><span
				class="pln"> </span><span class="pun">(</span><span class="kwd">new</span><span
				class="pln"> </span><span class="typ">Date</span><span class="pun">().</span><span
				class="pln">getTime</span><span class="pun">()</span><span class="pln"> </span><span
				class="pun">&lt;</span><span class="pln"> startTime </span><span class="pun">+</span><span class="pln"> milliSeconds</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; </span><span class="pun">}</span><span
				class="pln"><br><br>&nbsp; sleep</span><span class="pun">(</span><span class="lit">10000</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; </span><span class="kwd">return</span><span
				class="pln"> </span><span class="str">"Hello Start"</span><span class="pun">;</span><span
				class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br></span><span class="kwd">function</span><span
				class="pln"> upload</span><span class="pun">()</span><span class="pln"> </span><span
				class="pun">{</span><span class="pln"><br>&nbsp; console</span><span class="pun">.</span><span
				class="pln">log</span><span class="pun">(</span><span
				class="str">"Request handler 'upload' was called."</span><span class="pun">);</span><span
				class="pln"><br>&nbsp; </span><span class="kwd">return</span><span class="pln"> </span><span
				class="str">"Hello Upload"</span><span class="pun">;</span><span class="pln"><br></span><span
				class="pun">}</span><span class="pln"><br><br>exports</span><span class="pun">.</span><span class="pln">start </span><span
				class="pun">=</span><span class="pln"> start</span><span class="pun">;</span><span class="pln"><br>exports</span><span
				class="pun">.</span><span class="pln">upload </span><span class="pun">=</span><span
				class="pln"> upload</span><span class="pun">;</span></pre>
				
		<p>
			Просто объясню, что этот код делает: когда функция <em>start()</em> вызвана, Node.js ожидает 10 секунд и только тогда возвращает «Hello Start».
			Когда вызывается <em>upload()</em>, она выполняется немедленно, как и раньше.
		</p>
		<p>
			(Конечно, вы уже поняли, вместо засыпания на 10 секунд, в <em>start()</em> могут быть реальные блокирующие операции, такие как сложные длительные вычисления.)
		</p>
		<p>
			Давайте посмотрим, что поменялось.
		</p>
		<p>
			Как обычно, нам надо перезапустить сервер. 
			На этот раз я попрошу вас следовать немного более сложному «протоколу», чтобы увидеть, что произошло: во-первых, откройте браузер или таб.
			В первом окне браузера, введите, пожалуйста, <a href="http://localhost:8888/start" rel="nofollow">http://localhost:8888/start</a> в адресную строку, но не переходите пока по этому адресу!
			
		</p>
		<p>
			В адресную строку второго окна браузера введите <a href="http://localhost:8888/upload" rel="nofollow">http://localhost:8888/upload</a> и снова не переходите по адресу.
		</p>
		<p>
			Теперь сделайте, как описано далее: нажмите клавишу Enter в первом окне («/start»), а затем быстро переключитесь на второе окно («/upload») и нажмите тоже Enter.
		</p>
		<p>
			Что вы будете наблюдать: URL /start потребуется 10 секунд для загрузки, как мы и ожидали.
			Но URL /upload <em>так же</em> потребуется 10 секунд на загрузку, хотя в соответствующем обработчике запроса нет <em>sleep()</em>!
		</p>
		<p>
			Почему? Потому что <em>start()</em> содержит блокирующую операцию.
			Like in "it's blocking everything else from working".
		</p>
		<p>
			И в этом проблема, потому что, как говорят: <em>«В node всё работает параллельно, за исключением вашего кода»</em>.
		</p>
		<p>
			Это значит, что Node.js может обрабатывать одновременно множество вещей, но при этом не разделяет всё на отдельные потоки &mdash; Node.js однопоточный.
			Он делает это, запуская цикл событий, а мы, разработчики, можем использовать это &mdash; мы должны избегать блокирующих операций, где это возможно, и использовать неблокирующие операции вместо них.
		</p>
		<p>
			Но для этого нам надо использовать обратные вызовы, передавая функции внутри тех функций, которые могут сделать то, что занимает некоторое время (как например sleep() на 10 секунд или запрос к базе данных или какое-то дорогостоящее вычисление.)
		</p>
		<p>
			Таким образом, мы как бы говорим: <em>«Эй, возможноДолгаяФункция(), пожалуйста, сделай вот это, но я, однопотоковый Node.js, не собираюсь ждать здесь, пока ты закончишь, я продолжу выполнение строчек кода ниже тебя, а ты возьми пока вот эту функцию callbackFunction() и вызови её, когда всё сделаешь. Спасибо!»</em>
		</p>
		<p>
			(Если хотите почитать об этом более подробно, пожалуйста посмотрите пост Mixu на <a href="http://blog.mixu.net/2011/02/01/understanding-the-node-js-event-loop/">Understanding the node.js event loop</a>.)
		</p>
		<p>
			И мы сейчас увидим, почему способ, которым мы создали «обработчик запроса обрабатывающий ответ» в нашем приложении не позволит правильно использовать неблокирующие операции.
		</p>
		<p>
			Ещё раз давайте попробуем испытать проблему на своей шкуре, модифицировав наше приложение. 
		</p>
		<p>
			Мы снова используем наш обработчик запроса <em>start</em>. Пожалуйста, измените его следующим образом (файл <em>requestHandlers.js</em>)
		</p>

		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> exec </span><span
				class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span class="str">"child_process"</span><span
				class="pun">).</span><span class="pln">exec</span><span class="pun">;</span><span
				class="pln"><br><br></span><span class="kwd">function</span><span class="pln"> start</span><span
				class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request handler 'start' was called."</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; </span><span class="kwd">var</span><span class="pln"> content </span><span
				class="pun">=</span><span class="pln"> </span><span class="str">"empty"</span><span class="pun">;</span><span
				class="pln"><br><br>&nbsp; exec</span><span class="pun">(</span><span class="str">"ls -lah"</span><span
				class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span
				class="pln"> </span><span class="pun">(</span><span class="pln">error</span><span
				class="pun">,</span><span class="pln"> stdout</span><span class="pun">,</span><span
				class="pln"> stderr</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span
				class="pln"><br>&nbsp; &nbsp; content </span><span class="pun">=</span><span
				class="pln"> stdout</span><span class="pun">;</span><span class="pln"><br>&nbsp; </span><span
				class="pun">});</span><span class="pln"><br><br>&nbsp; </span><span class="kwd">return</span><span
				class="pln"> content</span><span class="pun">;</span><span class="pln"><br></span><span
				class="pun">}</span><span class="pln"><br><br></span><span class="kwd">function</span><span class="pln"> upload</span><span
				class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request handler 'upload' was called."</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; </span><span class="kwd">return</span><span
				class="pln"> </span><span class="str">"Hello Upload"</span><span class="pun">;</span><span
				class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br>exports</span><span
				class="pun">.</span><span class="pln">start </span><span class="pun">=</span><span
				class="pln"> start</span><span class="pun">;</span><span class="pln"><br>exports</span><span
				class="pun">.</span><span class="pln">upload </span><span class="pun">=</span><span
				class="pln"> upload</span><span class="pun">;</span></pre>
				
		<p>
			Как можно видеть, мы просто внедрили новый модуль Node.js <em>child_process</em>.
			Мы сделали так, потому что это позволит нам использовать очень простую, но полезную неблокирующую операцию: <em>exec()</em>.
		</p>
		<p>
			Что делает <em>exec()</em> — она выполняет shell-команду внутри Node.js.
			В этом примере мы собираемся использовать её, чтобы получить список всех файлов в текущей директории ("ls -lah"), позволяя нам отобразить этот список в браузере пользователя, запросившего URL <em>/start</em>.
		</p>
		<p>
			Что делает этот код: создает новую переменную <em>content</em> (с начальным значением "empty"), выполняет "ls -lah", заполняет переменную результатом и возвращает её.
		</p>
		<p>
			Как обычно, запустим наше приложение и посетим <a href="http://localhost:8888/start" rel="nofollow">http://localhost:8888/start</a>.
		</p>
		<p>
			Которая загрузит нам красивую страничку со строкой "empty". Что тут не так?
		</p>
		<p>
			Ну, как вы уже догадались, <em>exec()</em> делает свою магию в неблокирующий манере.
			Это хорошая штука, потому что таким образом мы можем выполнять очень дорогостоящие shell-операции (как, например, копирование больших файлов или что-то подобное), не заставляя наше приложение полностью останавливаться, пока блокирующая <em>sleep</em>-операция не выполнится.
		</p>
		<p>
			Если хотите удостовериться, замените "ls -lah" на более дорогостоящую операцию "find /").
		</p>
		<p>
			Но мы не совсем довольны своей элегантной неблокирующей операцией, когда наш браузер не отображает её результат, не так ли?
		</p>
		<p>
			Давайте тогда пофиксим это. Давайте попытаемся понять, почему текущая архитектура не работает.
		</p>
		<p>
			Проблемой является то, что <em>exec()</em>, чтобы работать без блокирования, использует callback-функцию.
		</p>
		<p>
			В нашем примере это анонимная функция, которая передаётся как второй параметр в функцию <em>exec()</em>:
		</p>

		<pre class="prettyprint lang-js"><span class="kwd">function</span><span class="pln"> </span><span
				class="pun">(</span><span class="pln">error</span><span class="pun">,</span><span
				class="pln"> stdout</span><span class="pun">,</span><span class="pln"> stderr</span><span
				class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; content </span><span
				class="pun">=</span><span class="pln"> stdout</span><span class="pun">;</span><span
				class="pln"><br></span><span class="pun">}</span></pre>
				
		<p>
			И здесь лежит корень нашей проблемы: наш собственный код исполняется синхронно, что означает, что сразу после вызова <em>exec()</em>, Node.js продолжит выполнять <em>return content;</em>.
			К этому моменту <em>content</em> ещё "empty", из-за того, что callback-функция, переданная в <em>exec()</em>, до сих пор не вызвана &mdash; потому что операция <em>exec()</em> асинхронная.
		</p>
		<p>
			Теперь "ls -lah" &mdash; очень недорогая и быстрая операция (если только в директории не миллион файлов).
			Именно поэтому callback вызывается относительно оперативно &mdash; но это, всё же, происходит асинхронно.
		</p>
		<p>
			Использование более дорогостоящих команд делает это более очевидным: "find /" занимает около 1 минуты на моей машине, но если я заменяю "ls -lah" на "find /" в обработчике запроса, то я всё ещё немедленно получаю HTTP-ответ, когда открываю URL /start.
			Ясно, что <em>exec()</em> делает что-то в фоновом режиме, пока Node.js продолжает исполнять приложение и мы можем предположить, что callback-функция, которую мы передали в <em>exec()</em>, будет вызвана только когда команда "find /" закончит выполняться.
		</p>
		<p>
			Но как нам достичь нашей цели, то есть, показать пользователю список файлов в текущей директории?
		</p>
		<p>
			Теперь, после изучения вопроса о том, как делать <em>не</em> надо, давайте обсудим, как заставить наши обработчики запроса реагировать на запросы браузера правильно.
		</p>

		<a name="responding-request-handlers-with-non-blocking-operations"></a>
		
		<h4>Ответ обработчиков запроса с неблокирующими операциями.</h4>
		<p>
			Я употребил фразу «правильный способ». 
			Опасная вещь. 
			Довольно часто не существует единого «правильного способа».
		</p>
		<p>
			Но одним из возможных решений для этого является, как это часто бывает с Node.js, передача функции внутри. 
			Давайте рассмотрим это.
		</p>
		<p>
			Сейчас наше приложение способно транспортировать контент (который обработчики запроса хотели бы показать пользователю) от обработчиков запроса к HTTP-серверу, возвращая его через слои приложения (обработчик запроса -&gt; роутер -&gt; сервер).
		</p>
		<p>
			Наш новый подход заключается в следующем: вместо доставки контента серверу мы будем сервер доставлять к контенту. 
			Чтобы быть более точным, мы будем внедрять объект <em>response</em> (из серверной callback-функции <em>onRequest()</em>) через роутер в обработчики запроса.
			Обработчики смогут тогда использовать функции этого объекта для ответа на сами запросы.
		</p>
		<p>
			Достаточно разъяснений. Вот &mdash; пошаговый рецепт изменения нашего приложения.
		</p>
		<p>
			Начнём с нашего <em>server.js</em>:
		</p>

		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> http </span><span
				class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span
				class="str">"http"</span><span class="pun">);</span><span class="pln"><br></span><span
				class="kwd">var</span><span class="pln"> url </span><span class="pun">=</span><span
				class="pln"> require</span><span class="pun">(</span><span class="str">"url"</span><span
				class="pun">);</span><span class="pln"><br><br></span><span class="kwd">function</span><span
				class="pln"> start</span><span class="pun">(</span><span class="pln">route</span><span
				class="pun">,</span><span class="pln"> handle</span><span class="pun">)</span><span class="pln"> </span><span
				class="pun">{</span><span class="pln"><br>&nbsp; </span><span class="kwd">function</span><span
				class="pln"> onRequest</span><span class="pun">(</span><span class="pln">request</span><span
				class="pun">,</span><span class="pln"> response</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="kwd">var</span><span class="pln"> pathname </span><span class="pun">=</span><span class="pln"> url</span><span
				class="pun">.</span><span class="pln">parse</span><span class="pun">(</span><span
				class="pln">request</span><span class="pun">.</span><span class="pln">url</span><span
				class="pun">).</span><span class="pln">pathname</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request for "</span><span
				class="pln"> </span><span class="pun">+</span><span class="pln"> pathname </span><span
				class="pun">+</span><span class="pln"> </span><span class="str">" received."</span><span
				class="pun">);</span><span class="pln"><br><br>&nbsp; &nbsp; route</span><span class="pun">(</span><span
				class="pln">handle</span><span class="pun">,</span><span class="pln"> pathname</span><span
				class="pun">,</span><span class="pln"> response</span><span class="pun">);</span><span class="pln"><br>&nbsp; </span><span
				class="pun">}</span><span class="pln"><br><br>&nbsp; http</span><span class="pun">.</span><span
				class="pln">createServer</span><span class="pun">(</span><span class="pln">onRequest</span><span
				class="pun">).</span><span class="pln">listen</span><span class="pun">(</span><span
				class="lit">8888</span><span class="pun">);</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Server has started."</span><span
				class="pun">);</span><span class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br>exports</span><span
				class="pun">.</span><span class="pln">start </span><span class="pun">=</span><span
				class="pln"> start</span><span class="pun">;</span></pre>
				
		<p>
			Вместо ожидания возврата значения от функции <em>route()</em>, мы передаём наш объект <em>response</em> в качестве третьего параметра.
			Кроме того, мы удалили всякие вызовы методов <em>response</em> из обработчика <em>onRequest()</em>, потому что мы рассчитываем, что <em>route</em> позаботится об этом.
		</p>
		<p>
			Далее идёт <em>router.js</em>:
		</p>
		
		<pre class="prettyprint lang-js"><span class="kwd">function</span><span class="pln"> route</span><span
				class="pun">(</span><span class="pln">handle</span><span class="pun">,</span><span
				class="pln"> pathname</span><span class="pun">,</span><span class="pln"> response</span><span
				class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"About to route a request for "</span><span
				class="pln"> </span><span class="pun">+</span><span class="pln"> pathname</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; </span><span class="kwd">if</span><span
				class="pln"> </span><span class="pun">(</span><span class="kwd">typeof</span><span
				class="pln"> handle</span><span class="pun">[</span><span class="pln">pathname</span><span
				class="pun">]</span><span class="pln"> </span><span class="pun">===</span><span
				class="pln"> </span><span class="str">'function'</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; handle</span><span
				class="pun">[</span><span class="pln">pathname</span><span class="pun">](</span><span class="pln">response</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; </span><span class="pun">}</span><span
				class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span
				class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; console</span><span class="pun">.</span><span
				class="pln">log</span><span class="pun">(</span><span class="str">"No request handler found for "</span><span
				class="pln"> </span><span class="pun">+</span><span class="pln"> pathname</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">writeHead</span><span class="pun">(</span><span class="lit">404</span><span
				class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span
				class="str">"Content-Type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"text/plain"</span><span
				class="pun">});</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="str">"404 Not found"</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">end</span><span class="pun">();</span><span class="pln"><br>&nbsp; </span><span class="pun">}</span><span
				class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br>exports</span><span
				class="pun">.</span><span class="pln">route </span><span class="pun">=</span><span
				class="pln"> route</span><span class="pun">;</span></pre>
				
		<p>
			Та же схема: вместо ожидания возврата значения от наших обработчиков события, мы передаём объект <em>respond</em>.
		</p>
		<p>
			Если обработчик запроса не может быть использован, мы заботимся об ответе с надлежащим заголовком «404» и телом ответа.
		</p>
		<p>
			И последнее, но не менее важное, мы модифицируем <em>requestHandlers.js</em>:
		</p>

		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> exec </span><span
				class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span class="str">"child_process"</span><span
				class="pun">).</span><span class="pln">exec</span><span class="pun">;</span><span
				class="pln"><br><br></span><span class="kwd">function</span><span class="pln"> start</span><span
				class="pun">(</span><span class="pln">response</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request handler 'start' was called."</span><span
				class="pun">);</span><span class="pln"><br><br>&nbsp; exec</span><span class="pun">(</span><span
				class="str">"ls -lah"</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span
				class="pln"> </span><span class="pun">(</span><span class="pln">error</span><span
				class="pun">,</span><span class="pln"> stdout</span><span class="pun">,</span><span
				class="pln"> stderr</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span
				class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">writeHead</span><span class="pun">(</span><span class="lit">200</span><span
				class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span
				class="str">"Content-Type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"text/plain"</span><span
				class="pun">});</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="pln">stdout</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">end</span><span class="pun">();</span><span class="pln"><br>&nbsp; </span><span class="pun">});</span><span
				class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br></span><span class="kwd">function</span><span
				class="pln"> upload</span><span class="pun">(</span><span class="pln">response</span><span
				class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request handler 'upload' was called."</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; response</span><span class="pun">.</span><span
				class="pln">writeHead</span><span class="pun">(</span><span class="lit">200</span><span
				class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span
				class="str">"Content-Type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"text/plain"</span><span
				class="pun">});</span><span class="pln"><br>&nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="str">"Hello Upload"</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; response</span><span class="pun">.</span><span
				class="pln">end</span><span class="pun">();</span><span class="pln"><br></span><span
				class="pun">}</span><span class="pln"><br><br>exports</span><span class="pun">.</span><span class="pln">start </span><span
				class="pun">=</span><span class="pln"> start</span><span class="pun">;</span><span class="pln"><br>exports</span><span
				class="pun">.</span><span class="pln">upload </span><span class="pun">=</span><span
				class="pln"> upload</span><span class="pun">;</span></pre>
				
		<p>
			Наши функции-обработчики должны принять параметр response и использовать его, чтобы ответить на запрос напрямую.
		</p>
		<p>
			Обработчик <em>start</em> будет отвечать изнутри анонимного обратного вызова <em>exec()</em>, а обработчик <em>upload</em> будет всё ещё выдавать «Hello Upload», но теперь посредством объекта <em>response</em>.
		</p>
		<p>
			Если вы запустили наше приложение снова (<em>node index.js</em>), всё должно работать как и ожидалось.
		</p>
		<p>
			Если хотите убедиться, что дорогостоящая операция в <em>/start</em> больше не будет блокировать запросы на <em>/upload</em>, модифицируйте ваш <em>requestHandlers.js</em> как показано далее:
		</p>

		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> exec </span><span
				class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span class="str">"child_process"</span><span
				class="pun">).</span><span class="pln">exec</span><span class="pun">;</span><span
				class="pln"><br><br></span><span class="kwd">function</span><span class="pln"> start</span><span
				class="pun">(</span><span class="pln">response</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request handler 'start' was called."</span><span
				class="pun">);</span><span class="pln"><br><br>&nbsp; exec</span><span class="pun">(</span><span
				class="str">"find /"</span><span class="pun">,</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="pun">{</span><span class="pln"> timeout</span><span class="pun">:</span><span
				class="pln"> </span><span class="lit">10000</span><span class="pun">,</span><span
				class="pln"> maxBuffer</span><span class="pun">:</span><span class="pln"> </span><span
				class="lit">20000</span><span class="pun">*</span><span class="lit">1024</span><span
				class="pln"> </span><span class="pun">},</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span
				class="pln">error</span><span class="pun">,</span><span class="pln"> stdout</span><span
				class="pun">,</span><span class="pln"> stderr</span><span class="pun">)</span><span class="pln"> </span><span
				class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">writeHead</span><span class="pun">(</span><span class="lit">200</span><span
				class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span
				class="str">"Content-Type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"text/plain"</span><span
				class="pun">});</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; response</span><span
				class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span
				class="pln">stdout</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; response</span><span
				class="pun">.</span><span class="pln">end</span><span class="pun">();</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="pun">});</span><span class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br></span><span
				class="kwd">function</span><span class="pln"> upload</span><span class="pun">(</span><span class="pln">response</span><span
				class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request handler 'upload' was called."</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; response</span><span class="pun">.</span><span
				class="pln">writeHead</span><span class="pun">(</span><span class="lit">200</span><span
				class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span
				class="str">"Content-Type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"text/plain"</span><span
				class="pun">});</span><span class="pln"><br>&nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="str">"Hello Upload"</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; response</span><span class="pun">.</span><span
				class="pln">end</span><span class="pun">();</span><span class="pln"><br></span><span
				class="pun">}</span><span class="pln"><br><br>exports</span><span class="pun">.</span><span class="pln">start </span><span
				class="pun">=</span><span class="pln"> start</span><span class="pun">;</span><span class="pln"><br>exports</span><span
				class="pun">.</span><span class="pln">upload </span><span class="pun">=</span><span
				class="pln"> upload</span><span class="pun">;</span></pre>
				
		<p>
			Благодаря этому, HTTP-запросы к <a href="http://localhost:8888/start" rel="nofollow">http://localhost:8888/start</a> будут занимать не менее 10 секунд, но запросы к <a href="http://localhost:8888/upload" rel="nofollow">http://localhost:8888/upload</a> будут получать ответ немедленно, даже если /start всё ещё занят вычислениями.
		</p>

		<a name="serving-something-useful"></a>
		
		<h3>Сделаем что-нибудь полезное</h3>
		
		<p>
			До сих пор мы делали всё прекрасно и изысканно, но мы не создали ничего значимого для клиентов нашего супер-сайта.
		</p>
		<p>
			Наш сервер, роутер и обработчики запроса находятся на своих местах, таким образом, теперь мы можем начать добавлять контент на наш сайт, который позволяет нашим пользователям выбирать файл, загружать его и просматривать загруженный файл в браузере.
			Для простоты будем полагать, что через наше приложение будут загружаться и показываться только файлы картинок.
		</p>
		<p>
			OK, давайте шаг за шагом, но с разъяснением больших техник и принципов JavaScript, и в то же время, давайте немного ускоримся.
			Автору слишком нравится слушать самого себя.
		</p>
		<p>
			Здесь "шаг за шагом" означает примерно 2 шага: сначала мы посмотрим как обрабатывать входящие POST-запросы (но не загрузку файла), и на втором шаге мы используем внешний модуль Node.js для обработки загрузки файла.
			Я выбирал этот подход по двум причинам.
		</p>
		<p>
			Во-первых, обрабатывать базовые POST-запросы относительно просто в Node.js, но для обучения это &mdash; достаточно стоящее упражнение.
			<br/>
			Во-вторых, обработка загрузки файла (к примеру, multipart POST-запросы) это <em>не так просто</em> в Node.js, поэтому выходит за рамки этого учебника, но пример использования для этого внешнего модуля имеет смысл включить в учебник для начинающих.
		</p>

		<a name="handling-post-requests"></a>
		
		<h4>Обработка POST-запросов</h4>
		
		<p>
			Давайте сделаем попроще: предоставим текcтовое поле, которое может быть заполнено пользователем и отправлено на сервер в POST-запросе.
			После получения и обработки этого запроса мы отобразим содержимое текстового поля.
		</p>
		<p>
			HTML-код для формы текстового поля должен формировать наш обработчик запроса <em>/start</em>, так давайте сразу же добавим его в файл <em>requestHandlers.js</em>:
		</p>

		<pre class="prettyprint lang-js"><span class="kwd">function</span><span class="pln"> start</span><span
				class="pun">(</span><span class="pln">response</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request handler 'start' was called."</span><span
				class="pun">);</span><span class="pln"><br><br>&nbsp; </span><span class="kwd">var</span><span
				class="pln"> body </span><span class="pun">=</span><span class="pln"> </span><span class="str">'&lt;html&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'&lt;head&gt;'</span><span class="pun">+</span><span
				class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;meta http-equiv="Content-Type" content="text/html; '</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'charset=UTF-8" /&gt;'</span><span class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'&lt;/head&gt;'</span><span class="pun">+</span><span
				class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;body&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;form action="/upload" method="post"&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;textarea name="text" rows="20" cols="60"&gt;&lt;/textarea&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;input type="submit" value="Submit text" /&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'&lt;/form&gt;'</span><span class="pun">+</span><span
				class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;/body&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'&lt;/html&gt;'</span><span class="pun">;</span><span class="pln"><br><br>&nbsp; &nbsp; response</span><span
				class="pun">.</span><span class="pln">writeHead</span><span class="pun">(</span><span
				class="lit">200</span><span class="pun">,</span><span class="pln"> </span><span
				class="pun">{</span><span class="str">"Content-Type"</span><span class="pun">:</span><span
				class="pln"> </span><span class="str">"text/html"</span><span class="pun">});</span><span
				class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="pln">body</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">end</span><span class="pun">();</span><span class="pln"><br></span><span
				class="pun">}</span><span class="pln"><br><br></span><span class="kwd">function</span><span class="pln"> upload</span><span
				class="pun">(</span><span class="pln">response</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request handler 'upload' was called."</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; response</span><span class="pun">.</span><span
				class="pln">writeHead</span><span class="pun">(</span><span class="lit">200</span><span
				class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span
				class="str">"Content-Type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"text/plain"</span><span
				class="pun">});</span><span class="pln"><br>&nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="str">"Hello Upload"</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; response</span><span class="pun">.</span><span
				class="pln">end</span><span class="pun">();</span><span class="pln"><br></span><span
				class="pun">}</span><span class="pln"><br><br>exports</span><span class="pun">.</span><span class="pln">start </span><span
				class="pun">=</span><span class="pln"> start</span><span class="pun">;</span><span class="pln"><br>exports</span><span
				class="pun">.</span><span class="pln">upload </span><span class="pun">=</span><span
				class="pln"> upload</span><span class="pun">;</span></pre>
				
		<p>
			Если теперь этот код не выиграет Webby Awards, то я не знаю, какой сможет.
			Вы должны увидеть эту очень простую форму, когда запросите <a href="http://localhost:8888/start" rel="nofollow">http://localhost:8888/start</a> в вашем браузере.
			Если это не так &mdash; возможно, вы не перезагрузили приложение.
		</p>
		<p>
			Я уже слышу вас: помещать содержимое представления прямо в обработчик запроса некрасиво.
			Тем не менее, я решил не включать этот дополнительный уровень абстракции (то есть, разделение представления и логики) в наш учебник, потому что, я думаю, что это не научит нас чему-нибудь стоящему в контексте JavaScript или Node.js.
		</p>
		<p>
			Давайте лучше использовать появившееся окно для более интересных проблем, то есть, обработки POST-запроса в нашем обработчике запроса <em>/upload</em> при отправке этой формы пользователем.
		</p>
		<p>
			Теперь, когда мы стали экспертными новичками, мы уже не удивляемся тому факту, что обработка POST-данных делается в неблокирующей манере, через использование асинхронных callback-ов.
		</p>
		<p>
			Это имеет смысл, потому что POST-запросы могут быть потенциально очень большими &mdash; ничто не мешает пользователю ввести текст размером в несколько мегабайтов.
			Обработка всего массива данных за один раз может привести к блокирующей операции.
		</p>
		<p>
			Чтобы сделать весь процесс неблокирующим, Node.js обслуживает POST-данные небольшими порциями, а callback-функции вызываются при определённых событиях.
			Эти события &mdash; <em>data</em> (когда приходит новая порция POST-данных) и <em>end</em> (когда все части данных были получены).
		</p>
		<p>
			Надо сообщить Node.js, какие функции вызывать, когда эти события произойдут.
			Это делается путём добавления слушателей (<em>listeners</em>) в объект <em>request</em>, который передаётся в нашу callback-функцию <em>onRequest</em>, когда HTTP-запрос получен.
		</p>
		<p>
			В основном, это выглядит так:
		</p>

		<pre class="prettyprint lang-js"><span class="pln">request</span><span class="pun">.</span><span class="pln">addListener</span><span
				class="pun">(</span><span class="str">"data"</span><span class="pun">,</span><span
				class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span
				class="pln">chunk</span><span class="pun">)</span><span class="pln"> </span><span
				class="pun">{</span><span class="pln"><br>&nbsp; </span><span class="com">// called when a new chunk of data was received</span><span
				class="pln"><br></span><span class="pun">});</span><span class="pln"><br><br>request</span><span
				class="pun">.</span><span class="pln">addListener</span><span class="pun">(</span><span class="str">"end"</span><span
				class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span
				class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span
				class="pln"><br>&nbsp; </span><span
				class="com">// called when all chunks of data have been received</span><span
				class="pln"><br></span><span class="pun">});</span></pre>
				
		<p> 
			Возникает вопрос, где реализовать эту логику.
			В настоящее время мы можем получить доступ к объекту <em>request</em> только в нашем сервере &mdash; мы не передаём его в роутер и в обработчики запроса, как делаем это с объектом <em>response</em>.
		</p> 
		<p> 
			На мой взгляд, это работа HTTP-сервера &mdash; предоставлять приложению все данные из запросов.
			Поэтому я предлагаю обрабатывать POST-данные прямо в сервере и передавать конечные данные в роутер и обработчики запроса, которые сами решат, что с ними делать.
		</p>
		<p> 
			Таким образом, идея &mdash; в том, чтобы поместить обратные вызовы событий <em>data</em> и <em>end</em> в сервер, собирать все куски POST-данных в <em>data</em> и вызывать роутер при получении события <em>end</em>, пока идёт передача собранных порций данных в роутер, который в свою очередь передаёт их в обработчики запроса.
		</p>
		<p>
			Начинаем с <em>server.js</em>:
		</p>

		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> http </span><span
				class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span
				class="str">"http"</span><span class="pun">);</span><span class="pln"><br></span><span
				class="kwd">var</span><span class="pln"> url </span><span class="pun">=</span><span
				class="pln"> require</span><span class="pun">(</span><span class="str">"url"</span><span
				class="pun">);</span><span class="pln"><br><br></span><span class="kwd">function</span><span
				class="pln"> start</span><span class="pun">(</span><span class="pln">route</span><span
				class="pun">,</span><span class="pln"> handle</span><span class="pun">)</span><span class="pln"> </span><span
				class="pun">{</span><span class="pln"><br>&nbsp; </span><span class="kwd">function</span><span
				class="pln"> onRequest</span><span class="pun">(</span><span class="pln">request</span><span
				class="pun">,</span><span class="pln"> response</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="kwd">var</span><span class="pln"> postData </span><span class="pun">=</span><span
				class="pln"> </span><span class="str">""</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="kwd">var</span><span class="pln"> pathname </span><span class="pun">=</span><span class="pln"> url</span><span
				class="pun">.</span><span class="pln">parse</span><span class="pun">(</span><span
				class="pln">request</span><span class="pun">.</span><span class="pln">url</span><span
				class="pun">).</span><span class="pln">pathname</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request for "</span><span
				class="pln"> </span><span class="pun">+</span><span class="pln"> pathname </span><span
				class="pun">+</span><span class="pln"> </span><span class="str">" received."</span><span
				class="pun">);</span><span class="pln"><br><br>&nbsp; &nbsp; request</span><span
				class="pun">.</span><span class="pln">setEncoding</span><span class="pun">(</span><span class="str">"utf8"</span><span
				class="pun">);</span><span class="pln"><br><br>&nbsp; &nbsp; request</span><span
				class="pun">.</span><span class="pln">addListener</span><span class="pun">(</span><span class="str">"data"</span><span
				class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span
				class="pun">(</span><span class="pln">postDataChunk</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span
				class="pln"><br>&nbsp; &nbsp; &nbsp; postData </span><span class="pun">+=</span><span class="pln"> postDataChunk</span><span
				class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Received POST data chunk '"</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; postDataChunk </span><span
				class="pun">+</span><span class="pln"> </span><span class="str">"'."</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="pun">});</span><span
				class="pln"><br><br>&nbsp; &nbsp; request</span><span class="pun">.</span><span
				class="pln">addListener</span><span class="pun">(</span><span class="str">"end"</span><span class="pun">,</span><span
				class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span
				class="pln"> </span><span class="pun">{</span><span
				class="pln"><br>&nbsp; &nbsp; &nbsp; route</span><span class="pun">(</span><span
				class="pln">handle</span><span class="pun">,</span><span class="pln"> pathname</span><span
				class="pun">,</span><span class="pln"> response</span><span class="pun">,</span><span class="pln"> postData</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="pun">});</span><span
				class="pln"><br><br>&nbsp; </span><span class="pun">}</span><span class="pln"><br><br>&nbsp; http</span><span
				class="pun">.</span><span class="pln">createServer</span><span class="pun">(</span><span class="pln">onRequest</span><span
				class="pun">).</span><span class="pln">listen</span><span class="pun">(</span><span
				class="lit">8888</span><span class="pun">);</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Server has started."</span><span
				class="pun">);</span><span class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br>exports</span><span
				class="pun">.</span><span class="pln">start </span><span class="pun">=</span><span
				class="pln"> start</span><span class="pun">;</span></pre>
		
		<p>
			Здесь, в основном, мы сделали три вещи: во-первых, определили, что ожидаем полученные данные в кодировке UTF-8, затем добавили слушатель для события «data», который шаг за шагом заполняет нашу новую переменную <em>postData</em> всякий раз, когда прибывает новая порция POST-данных, и далее &mdash; переходим к вызову нашего роутера в обратном вызове события <em>end</em>, чтобы убедиться, что вызов происходит, когда все POST-данные собраны.
			Мы также передаём POST-данные в роутере, потому что они нам понадобятся в обработчиках запроса.
		</p>
		<p>
			Добавление логирования в консоли для каждой порции полученных данных &mdash; возможно, плохая идея для конечного кода (мегабайты POST-данных, помните?), но это имеет смысл, чтобы посмотреть, что происходит.
		</p>
		<p>
			Я предлагаю немного поиграться с этим.
			Поместите в текстовое поле сначала немного текста, а потом больше, и вы увидите, что для больших текстов обратный вызов <em>data</em> действительно вызывается несколько раз.
		</p>
		<p>
			Давайте добавим ещё больше крутизны в наше приложение.
			На странице <em>/upload</em> мы будем показывать принятый контент.
			Чтобы сделать это возможным, нам необходимо передавать <em>postData</em> в обработчики запроса. В <em>router.js</em>:
		</p>

		<pre class="prettyprint lang-js"><span class="kwd">function</span><span class="pln"> route</span><span
				class="pun">(</span><span class="pln">handle</span><span class="pun">,</span><span
				class="pln"> pathname</span><span class="pun">,</span><span class="pln"> response</span><span
				class="pun">,</span><span class="pln"> postData</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"About to route a request for "</span><span
				class="pln"> </span><span class="pun">+</span><span class="pln"> pathname</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; </span><span class="kwd">if</span><span
				class="pln"> </span><span class="pun">(</span><span class="kwd">typeof</span><span
				class="pln"> handle</span><span class="pun">[</span><span class="pln">pathname</span><span
				class="pun">]</span><span class="pln"> </span><span class="pun">===</span><span
				class="pln"> </span><span class="str">'function'</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; handle</span><span
				class="pun">[</span><span class="pln">pathname</span><span class="pun">](</span><span class="pln">response</span><span
				class="pun">,</span><span class="pln"> postData</span><span class="pun">);</span><span class="pln"><br>&nbsp; </span><span
				class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"No request handler found for "</span><span
				class="pln"> </span><span class="pun">+</span><span class="pln"> pathname</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">writeHead</span><span class="pun">(</span><span class="lit">404</span><span
				class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span
				class="str">"Content-Type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"text/plain"</span><span
				class="pun">});</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="str">"404 Not found"</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">end</span><span class="pun">();</span><span class="pln"><br>&nbsp; </span><span class="pun">}</span><span
				class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br>exports</span><span
				class="pun">.</span><span class="pln">route </span><span class="pun">=</span><span
				class="pln"> route</span><span class="pun">;</span></pre>
				
		<p>
			И в <em>requestHandlers.js</em> мы включаем эти данные в нашем ответе обработчика запроса <em>upload</em>:
		</p>

		<pre class="prettyprint lang-js"><span class="kwd">function</span><span class="pln"> start</span><span
				class="pun">(</span><span class="pln">response</span><span class="pun">,</span><span class="pln"> postData</span><span
				class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request handler 'start' was called."</span><span
				class="pun">);</span><span class="pln"><br><br>&nbsp; </span><span class="kwd">var</span><span
				class="pln"> body </span><span class="pun">=</span><span class="pln"> </span><span class="str">'&lt;html&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'&lt;head&gt;'</span><span class="pun">+</span><span
				class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;meta http-equiv="Content-Type" content="text/html; '</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'charset=UTF-8" /&gt;'</span><span class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'&lt;/head&gt;'</span><span class="pun">+</span><span
				class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;body&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;form action="/upload" method="post"&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;textarea name="text" rows="20" cols="60"&gt;&lt;/textarea&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;input type="submit" value="Submit text" /&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'&lt;/form&gt;'</span><span class="pun">+</span><span
				class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;/body&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'&lt;/html&gt;'</span><span class="pun">;</span><span class="pln"><br><br>&nbsp; &nbsp; response</span><span
				class="pun">.</span><span class="pln">writeHead</span><span class="pun">(</span><span
				class="lit">200</span><span class="pun">,</span><span class="pln"> </span><span
				class="pun">{</span><span class="str">"Content-Type"</span><span class="pun">:</span><span
				class="pln"> </span><span class="str">"text/html"</span><span class="pun">});</span><span
				class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="pln">body</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">end</span><span class="pun">();</span><span class="pln"><br></span><span
				class="pun">}</span><span class="pln"><br><br></span><span class="kwd">function</span><span class="pln"> upload</span><span
				class="pun">(</span><span class="pln">response</span><span class="pun">,</span><span class="pln"> postData</span><span
				class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request handler 'upload' was called."</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; response</span><span class="pun">.</span><span
				class="pln">writeHead</span><span class="pun">(</span><span class="lit">200</span><span
				class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span
				class="str">"Content-Type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"text/plain"</span><span
				class="pun">});</span><span class="pln"><br>&nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="str">"You've sent: "</span><span
				class="pln"> </span><span class="pun">+</span><span class="pln"> postData</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; response</span><span class="pun">.</span><span
				class="pln">end</span><span class="pun">();</span><span class="pln"><br></span><span
				class="pun">}</span><span class="pln"><br><br>exports</span><span class="pun">.</span><span class="pln">start </span><span
				class="pun">=</span><span class="pln"> start</span><span class="pun">;</span><span class="pln"><br>exports</span><span
				class="pun">.</span><span class="pln">upload </span><span class="pun">=</span><span
				class="pln"> upload</span><span class="pun">;</span></pre>

		<p>
			Вот и всё, теперь мы можем получить POST-данные и использовать их в наших обработчиках запроса.
		</p>
		<p>
			И последнее по этой теме: то, что мы передаём в роутер и обработчики запроса, является полным телом нашего POST-запроса.
			Мы, вероятно, захотим использовать индивидуальные поля, составляющие POST-данные, в нашем случае значение поля <em>text</em>.
		</p>
		<p>
			Мы уже читали про модуль <em>querystring</em>, который поможет нам с этим:
		</p>

		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> querystring </span><span
				class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span class="str">"querystring"</span><span
				class="pun">);</span><span class="pln"><br><br></span><span class="kwd">function</span><span
				class="pln"> start</span><span class="pun">(</span><span class="pln">response</span><span
				class="pun">,</span><span class="pln"> postData</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request handler 'start' was called."</span><span
				class="pun">);</span><span class="pln"><br><br>&nbsp; </span><span class="kwd">var</span><span
				class="pln"> body </span><span class="pun">=</span><span class="pln"> </span><span class="str">'&lt;html&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'&lt;head&gt;'</span><span class="pun">+</span><span
				class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;meta http-equiv="Content-Type" content="text/html; '</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'charset=UTF-8" /&gt;'</span><span class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'&lt;/head&gt;'</span><span class="pun">+</span><span
				class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;body&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;form action="/upload" method="post"&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;textarea name="text" rows="20" cols="60"&gt;&lt;/textarea&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;input type="submit" value="Submit text" /&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'&lt;/form&gt;'</span><span class="pun">+</span><span
				class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;/body&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'&lt;/html&gt;'</span><span class="pun">;</span><span class="pln"><br><br>&nbsp; &nbsp; response</span><span
				class="pun">.</span><span class="pln">writeHead</span><span class="pun">(</span><span
				class="lit">200</span><span class="pun">,</span><span class="pln"> </span><span
				class="pun">{</span><span class="str">"Content-Type"</span><span class="pun">:</span><span
				class="pln"> </span><span class="str">"text/html"</span><span class="pun">});</span><span
				class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="pln">body</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">end</span><span class="pun">();</span><span class="pln"><br></span><span
				class="pun">}</span><span class="pln"><br><br></span><span class="kwd">function</span><span class="pln"> upload</span><span
				class="pun">(</span><span class="pln">response</span><span class="pun">,</span><span class="pln"> postData</span><span
				class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request handler 'upload' was called."</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; response</span><span class="pun">.</span><span
				class="pln">writeHead</span><span class="pun">(</span><span class="lit">200</span><span
				class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span
				class="str">"Content-Type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"text/plain"</span><span
				class="pun">});</span><span class="pln"><br>&nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="str">"You've sent the text: "</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; querystring</span><span class="pun">.</span><span
				class="pln">parse</span><span class="pun">(</span><span class="pln">postData</span><span
				class="pun">).</span><span class="pln">text</span><span class="pun">);</span><span class="pln"><br>&nbsp; response</span><span
				class="pun">.</span><span class="pln">end</span><span class="pun">();</span><span
				class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br>exports</span><span
				class="pun">.</span><span class="pln">start </span><span class="pun">=</span><span
				class="pln"> start</span><span class="pun">;</span><span class="pln"><br>exports</span><span
				class="pun">.</span><span class="pln">upload </span><span class="pun">=</span><span
				class="pln"> upload</span><span class="pun">;</span></pre>
				
		<p>
			Это всё, что можно сказать про обработку POST-данных в рамках учебника для начинающих.
		</p>

		<a name="handling-file-uploads"></a>

		<h4>Обработка загрузки файлов</h4>

		<p>
			Давайте примемся за последний пункт нашего списка задач.
			Мы планировали дать возможность пользователям загружать файлы картинок и отображать загруженные картинки в браузере.
		</p>

		<p>
			В 90-х это могло бы быть квалифицировано как бизнес модель для IPO, сейчас же этого достаточно, чтобы научить нас двум вещам: как установливать внешнии библиотки Node.js и как их использовать в нашем коде.
		</p>

		<p>
			Внешний модуль, который мы собираемся использовать, <em>node-formidable</em> от Felix Geisendörfer.
			Этот модуль поможет нам абстрагироваться от мерзких деталей парсинга входящих файловых данных.
			В конце концов, обработка входящих файлов это не что иное, как «просто» обработка POST-данных, но, в действительности, дьявол кроется в деталях, поэтому в нашем случае имеет смысл использовать готовое решение.
		</p>

		<p>
			Чтобы использовать код Феликса, соответствующий модуль Node.js должен быть инсталлирован.
			На борту Node.js есть собственный менеджер пакетов, называемый <em>NPM</em>.
			Он позволяет нам инсталировать внешние модули Node.js в очень удобной форме.
			С учетом установленного Node.js, всё сводится к			
		</p>
		
		<pre class="prettyprint lang-bash"><span class="pln">npm install formidable</span></pre>

		<p>
			в нашей командной строке. Если вы в конце увидели следующее:
		</p>
		
		<pre class="prettyprint lang-bash"><span class="pln">npm info build </span><span class="typ">Success</span><span
				class="pun">:</span><span class="pln"> formidable@1</span><span class="pun">.</span><span class="lit">0.9</span><span
				class="pln"><br>npm ok</span></pre>

		<p>
			...это значит &mdash; всё хорошо.
		</p>

		<p>
			Модуль <em>formidable</em> теперь доступен в нашем коде &mdash; всё, что нужно, это просто запросить его как один из тех модулей, которые мы использовали ранее:
		</p>
		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> formidable </span><span
				class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span class="str">"formidable"</span><span
				class="pun">);</span></pre>

		<p>
			По сути, <em>formidable</em> делает форму, отправленную через HTTP POST, доступной для парсинга в Node.js.
			Всё, что нам надо &mdash; это создать новый экземпляр объекта <em>IncomingForm</em>, который является абстракцией отправленной формы и может быть использован для парсинга объекта <em>request</em> нашего HTTP-сервера, для полей и файлов, отправленных через эту форму.		
		</p>

		<p>
			Пример кода со страницы проекта node-formidable показывает, как разные части сочетаются друг с другом:
		</p>
		
		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> formidable </span><span
				class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span class="str">'formidable'</span><span
				class="pun">),</span><span class="pln"><br>&nbsp; &nbsp; http </span><span class="pun">=</span><span
				class="pln"> require</span><span class="pun">(</span><span class="str">'http'</span><span
				class="pun">),</span><span class="pln"><br>&nbsp; &nbsp; sys </span><span class="pun">=</span><span
				class="pln"> require</span><span class="pun">(</span><span class="str">'sys'</span><span
				class="pun">);</span><span class="pln"><br><br>http</span><span class="pun">.</span><span class="pln">createServer</span><span
				class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span
				class="pln">req</span><span class="pun">,</span><span class="pln"> res</span><span
				class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span
				class="pln"><br>&nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span
				class="pun">(</span><span class="pln">req</span><span class="pun">.</span><span
				class="pln">url </span><span class="pun">==</span><span class="pln"> </span><span
				class="str">'/upload'</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span
				class="pln"> req</span><span class="pun">.</span><span class="pln">method</span><span
				class="pun">.</span><span class="pln">toLowerCase</span><span class="pun">()</span><span
				class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="str">'post'</span><span
				class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="com">// parse a file upload</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">var</span><span
				class="pln"> form </span><span class="pun">=</span><span class="pln"> </span><span
				class="kwd">new</span><span class="pln"> formidable</span><span class="pun">.</span><span class="typ">IncomingForm</span><span
				class="pun">();</span><span class="pln"><br>&nbsp; &nbsp; form</span><span class="pun">.</span><span
				class="pln">parse</span><span class="pun">(</span><span class="pln">req</span><span class="pun">,</span><span
				class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span
				class="pln">err</span><span class="pun">,</span><span class="pln"> fields</span><span
				class="pun">,</span><span class="pln"> files</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; res</span><span
				class="pun">.</span><span class="pln">writeHead</span><span class="pun">(</span><span
				class="lit">200</span><span class="pun">,</span><span class="pln"> </span><span
				class="pun">{</span><span class="str">'content-type'</span><span class="pun">:</span><span
				class="pln"> </span><span class="str">'text/plain'</span><span class="pun">});</span><span
				class="pln"><br>&nbsp; &nbsp; &nbsp; res</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="str">'received upload:\n\n'</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; res</span><span
				class="pun">.</span><span class="pln">end</span><span class="pun">(</span><span
				class="pln">sys</span><span class="pun">.</span><span class="pln">inspect</span><span
				class="pun">({</span><span class="pln">fields</span><span class="pun">:</span><span
				class="pln"> fields</span><span class="pun">,</span><span class="pln"> files</span><span
				class="pun">:</span><span class="pln"> files</span><span class="pun">}));</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="pun">});</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">return</span><span
				class="pun">;</span><span class="pln"><br>&nbsp; </span><span class="pun">}</span><span class="pln"><br><br>&nbsp; </span><span
				class="com">// show a file upload form</span><span class="pln"><br>&nbsp; res</span><span
				class="pun">.</span><span class="pln">writeHead</span><span class="pun">(</span><span
				class="lit">200</span><span class="pun">,</span><span class="pln"> </span><span
				class="pun">{</span><span class="str">'content-type'</span><span class="pun">:</span><span
				class="pln"> </span><span class="str">'text/html'</span><span class="pun">});</span><span
				class="pln"><br>&nbsp; res</span><span class="pun">.</span><span class="pln">end</span><span
				class="pun">(</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;form action="/upload" enctype="multipart/form-data" '</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'method="post"&gt;'</span><span class="pun">+</span><span
				class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;input type="text" name="title"&gt;&lt;br&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;input type="file" name="upload" multiple="multiple"&gt;&lt;br&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;input type="submit" value="Upload"&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'&lt;/form&gt;'</span><span class="pln"><br>&nbsp; </span><span class="pun">);</span><span
				class="pln"><br></span><span class="pun">}).</span><span class="pln">listen</span><span
				class="pun">(</span><span class="lit">8888</span><span class="pun">);</span></pre>

		<p>
			Если вы поместите этот код в файл и исполните его посредством <em>node</em>, вы сможете отправлять простые формы, включая загрузку фото, и увидите, как организован объект <em>files</em>, который передавался в callback, определенном в вызове <em>form.parse</em>.
		</p>
		
		<pre class="lang-js">received upload:

{ fields: { title: 'Hello World' },
  files:
   { upload:
	  { size: 1558,
		path: '/tmp/1c747974a27a6292743669e91f29350b',
		name: 'us-flag.png',
		type: 'image/png',
		lastModifiedDate: Tue, 21 Jun 2011 07:02:41 GMT,
		_writeStream: [Object],
		length: [Getter],
		filename: [Getter],
		mime: [Getter] } } }</pre>

		<p>
			Чтобы выполнить последний пункт нашей задачи, мы должны включить логику парсинга форм модуля <em>formidable</em> в структуру нашего кода, плюс ко всему, надо разобраться, как отдавать контент загруженного файла (который сохранен в директории <em>/tmp</em>) браузеру.
		</p>

		<p>
			Давайте сначала решим последнюю задачу: если имеется файл картинки на вашем локальном диске, что сделать, чтобы передать его браузеру?
		</p>

		<p>
			Мы, очевидно, собираемся считать содержимое этого файла в наш Node.js-сервер, и неудивительно, что для этого имеется соответствующий модуль под названием <em>fs</em>.
		</p>

		<p>
			Давайте добавим ещё один обработчик запроса для URL <em>/show</em>, который будет "захардкоженно" показывать содержимое файла <em>/tmp/test.png</em>.
			Конечно же, имеет смысл в первую очередь поместить реальную png-картинку в этот каталог.
		</p>

		<p>
			Мы собираемся изменить <em>requestHandlers.js</em>, как показано далее:
		</p>

		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> querystring </span><span
				class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span class="str">"querystring"</span><span
				class="pun">),</span><span class="pln"><br>&nbsp; &nbsp; fs </span><span class="pun">=</span><span
				class="pln"> require</span><span class="pun">(</span><span class="str">"fs"</span><span
				class="pun">);</span><span class="pln"><br><br></span><span class="kwd">function</span><span
				class="pln"> start</span><span class="pun">(</span><span class="pln">response</span><span
				class="pun">,</span><span class="pln"> postData</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request handler 'start' was called."</span><span
				class="pun">);</span><span class="pln"><br><br>&nbsp; </span><span class="kwd">var</span><span
				class="pln"> body </span><span class="pun">=</span><span class="pln"> </span><span class="str">'&lt;html&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'&lt;head&gt;'</span><span class="pun">+</span><span
				class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;meta http-equiv="Content-Type" '</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="str">'content="text/html; charset=UTF-8" /&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'&lt;/head&gt;'</span><span class="pun">+</span><span
				class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;body&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;form action="/upload" method="post"&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;textarea name="text" rows="20" cols="60"&gt;&lt;/textarea&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;input type="submit" value="Submit text" /&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'&lt;/form&gt;'</span><span class="pun">+</span><span
				class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;/body&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'&lt;/html&gt;'</span><span class="pun">;</span><span class="pln"><br><br>&nbsp; &nbsp; response</span><span
				class="pun">.</span><span class="pln">writeHead</span><span class="pun">(</span><span
				class="lit">200</span><span class="pun">,</span><span class="pln"> </span><span
				class="pun">{</span><span class="str">"Content-Type"</span><span class="pun">:</span><span
				class="pln"> </span><span class="str">"text/html"</span><span class="pun">});</span><span
				class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="pln">body</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">end</span><span class="pun">();</span><span class="pln"><br></span><span
				class="pun">}</span><span class="pln"><br><br></span><span class="kwd">function</span><span class="pln"> upload</span><span
				class="pun">(</span><span class="pln">response</span><span class="pun">,</span><span class="pln"> postData</span><span
				class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request handler 'upload' was called."</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; response</span><span class="pun">.</span><span
				class="pln">writeHead</span><span class="pun">(</span><span class="lit">200</span><span
				class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span
				class="str">"Content-Type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"text/plain"</span><span
				class="pun">});</span><span class="pln"><br>&nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="str">"You've sent the text: "</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; querystring</span><span class="pun">.</span><span
				class="pln">parse</span><span class="pun">(</span><span class="pln">postData</span><span
				class="pun">).</span><span class="pln">text</span><span class="pun">);</span><span class="pln"><br>&nbsp; response</span><span
				class="pun">.</span><span class="pln">end</span><span class="pun">();</span><span
				class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br></span><span class="kwd">function</span><span
				class="pln"> show</span><span class="pun">(</span><span class="pln">response</span><span
				class="pun">,</span><span class="pln"> postData</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request handler 'show' was called."</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; fs</span><span class="pun">.</span><span class="pln">readFile</span><span
				class="pun">(</span><span class="str">"/tmp/test.png"</span><span class="pun">,</span><span
				class="pln"> </span><span class="str">"binary"</span><span class="pun">,</span><span
				class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span
				class="pln">error</span><span class="pun">,</span><span class="pln"> file</span><span
				class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="kwd">if</span><span class="pun">(</span><span class="pln">error</span><span
				class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; response</span><span
				class="pun">.</span><span class="pln">writeHead</span><span class="pun">(</span><span
				class="lit">500</span><span class="pun">,</span><span class="pln"> </span><span
				class="pun">{</span><span class="str">"Content-Type"</span><span class="pun">:</span><span
				class="pln"> </span><span class="str">"text/plain"</span><span class="pun">});</span><span
				class="pln"><br>&nbsp; &nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="pln">error </span><span
				class="pun">+</span><span class="pln"> </span><span class="str">"\n"</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; response</span><span
				class="pun">.</span><span class="pln">end</span><span class="pun">();</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; response</span><span
				class="pun">.</span><span class="pln">writeHead</span><span class="pun">(</span><span
				class="lit">200</span><span class="pun">,</span><span class="pln"> </span><span
				class="pun">{</span><span class="str">"Content-Type"</span><span class="pun">:</span><span
				class="pln"> </span><span class="str">"image/png"</span><span class="pun">});</span><span
				class="pln"><br>&nbsp; &nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="pln">file</span><span
				class="pun">,</span><span class="pln"> </span><span class="str">"binary"</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; response</span><span
				class="pun">.</span><span class="pln">end</span><span class="pun">();</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="pun">}</span><span class="pln"><br>&nbsp; </span><span class="pun">});</span><span
				class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br>exports</span><span
				class="pun">.</span><span class="pln">start </span><span class="pun">=</span><span
				class="pln"> start</span><span class="pun">;</span><span class="pln"><br>exports</span><span
				class="pun">.</span><span class="pln">upload </span><span class="pun">=</span><span
				class="pln"> upload</span><span class="pun">;</span><span class="pln"><br>exports</span><span
				class="pun">.</span><span class="pln">show </span><span class="pun">=</span><span
				class="pln"> show</span><span class="pun">;</span></pre>

		<p>
			Также, надо преобразовать новый обработчик запроса в URL вида <em>/show</em> в файле <em>index.js</em>:
		</p>
		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> server </span><span class="pun">=</span><span
				class="pln"> require</span><span class="pun">(</span><span class="str">"./server"</span><span
				class="pun">);</span><span class="pln"><br></span><span class="kwd">var</span><span
				class="pln"> router </span><span class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span
				class="str">"./router"</span><span class="pun">);</span><span class="pln"><br></span><span class="kwd">var</span><span
				class="pln"> requestHandlers </span><span class="pun">=</span><span class="pln"> require</span><span
				class="pun">(</span><span class="str">"./requestHandlers"</span><span class="pun">);</span><span
				class="pln"><br><br></span><span class="kwd">var</span><span class="pln"> handle </span><span
				class="pun">=</span><span class="pln"> </span><span class="pun">{}</span><span
				class="pln"><br>handle</span><span class="pun">[</span><span class="str">"/"</span><span
				class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> requestHandlers</span><span
				class="pun">.</span><span class="pln">start</span><span class="pun">;</span><span class="pln"><br>handle</span><span
				class="pun">[</span><span class="str">"/start"</span><span class="pun">]</span><span
				class="pln"> </span><span class="pun">=</span><span class="pln"> requestHandlers</span><span
				class="pun">.</span><span class="pln">start</span><span class="pun">;</span><span class="pln"><br>handle</span><span
				class="pun">[</span><span class="str">"/upload"</span><span class="pun">]</span><span
				class="pln"> </span><span class="pun">=</span><span class="pln"> requestHandlers</span><span
				class="pun">.</span><span class="pln">upload</span><span class="pun">;</span><span class="pln"><br>handle</span><span
				class="pun">[</span><span class="str">"/show"</span><span class="pun">]</span><span class="pln"> </span><span
				class="pun">=</span><span class="pln"> requestHandlers</span><span class="pun">.</span><span
				class="pln">show</span><span class="pun">;</span><span class="pln"><br><br>server</span><span
				class="pun">.</span><span class="pln">start</span><span class="pun">(</span><span
				class="pln">router</span><span class="pun">.</span><span class="pln">route</span><span
				class="pun">,</span><span class="pln"> handle</span><span class="pun">);</span></pre>

		<p>
			Перезапускаем сервер, открываем <a href="http://localhost:8888/show" rel="nofollow">http://localhost:8888/show</a> в браузере и видим картинку <em>/tmp/test.png</em>.
		</p>

		<p>
			Хорошо. Всё, что нам надо теперь &mdash; это:
		</p>
		
		<p>
			<ul>
				<li>
					добавить поле для загрузки файлов в форму, находящуюся по адресу <em>/start</em>,
				</li>
				<li>
					интегрировать <em>node-formidable</em> в обработчик запроса <em>upload</em>, чтобы сохранять загруженные файлы в <em>/tmp/test.png</em>,
				</li>
		
				<li>
					внедрить загруженную картинку в HTML, отдаваемый по URL <em>/upload</em>.
				</li>
			</ul>
		</p>

		<p>
			Первый шаг &mdash; простой. Нам надо добавить тип кодировки <em>multipart/form-data</em> в нашу HTML-форму, удалить текстовое поле, добавить поле загрузки файла и поменять текст кнопки отправки формы на «Upload file».
			Давайте просто сделаем это в файле <em>requestHandlers.js</em>:
		</p>

		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> querystring </span><span
				class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span class="str">"querystring"</span><span
				class="pun">),</span><span class="pln"><br>&nbsp; &nbsp; fs </span><span class="pun">=</span><span
				class="pln"> require</span><span class="pun">(</span><span class="str">"fs"</span><span
				class="pun">);</span><span class="pln"><br><br></span><span class="kwd">function</span><span
				class="pln"> start</span><span class="pun">(</span><span class="pln">response</span><span
				class="pun">,</span><span class="pln"> postData</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request handler 'start' was called."</span><span
				class="pun">);</span><span class="pln"><br><br>&nbsp; </span><span class="kwd">var</span><span
				class="pln"> body </span><span class="pun">=</span><span class="pln"> </span><span class="str">'&lt;html&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'&lt;head&gt;'</span><span class="pun">+</span><span
				class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;meta http-equiv="Content-Type" '</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="str">'content="text/html; charset=UTF-8" /&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'&lt;/head&gt;'</span><span class="pun">+</span><span
				class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;body&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;form action="/upload" enctype="multipart/form-data" '</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'method="post"&gt;'</span><span class="pun">+</span><span
				class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'&lt;input type="file" name="upload"&gt;'</span><span class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'&lt;input type="submit" value="Upload file" /&gt;'</span><span class="pun">+</span><span
				class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;/form&gt;'</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="str">'&lt;/body&gt;'</span><span class="pun">+</span><span
				class="pln"><br>&nbsp; &nbsp; </span><span class="str">'&lt;/html&gt;'</span><span
				class="pun">;</span><span class="pln"><br><br>&nbsp; &nbsp; response</span><span
				class="pun">.</span><span class="pln">writeHead</span><span class="pun">(</span><span
				class="lit">200</span><span class="pun">,</span><span class="pln"> </span><span
				class="pun">{</span><span class="str">"Content-Type"</span><span class="pun">:</span><span
				class="pln"> </span><span class="str">"text/html"</span><span class="pun">});</span><span
				class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="pln">body</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">end</span><span class="pun">();</span><span class="pln"><br></span><span
				class="pun">}</span><span class="pln"><br><br></span><span class="kwd">function</span><span class="pln"> upload</span><span
				class="pun">(</span><span class="pln">response</span><span class="pun">,</span><span class="pln"> postData</span><span
				class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request handler 'upload' was called."</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; response</span><span class="pun">.</span><span
				class="pln">writeHead</span><span class="pun">(</span><span class="lit">200</span><span
				class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span
				class="str">"Content-Type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"text/plain"</span><span
				class="pun">});</span><span class="pln"><br>&nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="str">"You've sent the text: "</span><span
				class="pun">+</span><span class="pln"><br>&nbsp; querystring</span><span class="pun">.</span><span
				class="pln">parse</span><span class="pun">(</span><span class="pln">postData</span><span
				class="pun">).</span><span class="pln">text</span><span class="pun">);</span><span class="pln"><br>&nbsp; response</span><span
				class="pun">.</span><span class="pln">end</span><span class="pun">();</span><span
				class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br></span><span class="kwd">function</span><span
				class="pln"> show</span><span class="pun">(</span><span class="pln">response</span><span
				class="pun">,</span><span class="pln"> postData</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request handler 'show' was called."</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; fs</span><span class="pun">.</span><span class="pln">readFile</span><span
				class="pun">(</span><span class="str">"/tmp/test.png"</span><span class="pun">,</span><span
				class="pln"> </span><span class="str">"binary"</span><span class="pun">,</span><span
				class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span
				class="pln">error</span><span class="pun">,</span><span class="pln"> file</span><span
				class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="kwd">if</span><span class="pun">(</span><span class="pln">error</span><span
				class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; response</span><span
				class="pun">.</span><span class="pln">writeHead</span><span class="pun">(</span><span
				class="lit">500</span><span class="pun">,</span><span class="pln"> </span><span
				class="pun">{</span><span class="str">"Content-Type"</span><span class="pun">:</span><span
				class="pln"> </span><span class="str">"text/plain"</span><span class="pun">});</span><span
				class="pln"><br>&nbsp; &nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="pln">error </span><span
				class="pun">+</span><span class="pln"> </span><span class="str">"\n"</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; response</span><span
				class="pun">.</span><span class="pln">end</span><span class="pun">();</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; response</span><span
				class="pun">.</span><span class="pln">writeHead</span><span class="pun">(</span><span
				class="lit">200</span><span class="pun">,</span><span class="pln"> </span><span
				class="pun">{</span><span class="str">"Content-Type"</span><span class="pun">:</span><span
				class="pln"> </span><span class="str">"image/png"</span><span class="pun">});</span><span
				class="pln"><br>&nbsp; &nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="pln">file</span><span
				class="pun">,</span><span class="pln"> </span><span class="str">"binary"</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; response</span><span
				class="pun">.</span><span class="pln">end</span><span class="pun">();</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="pun">}</span><span class="pln"><br>&nbsp; </span><span class="pun">});</span><span
				class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br>exports</span><span
				class="pun">.</span><span class="pln">start </span><span class="pun">=</span><span
				class="pln"> start</span><span class="pun">;</span><span class="pln"><br>exports</span><span
				class="pun">.</span><span class="pln">upload </span><span class="pun">=</span><span
				class="pln"> upload</span><span class="pun">;</span><span class="pln"><br>exports</span><span
				class="pun">.</span><span class="pln">show </span><span class="pun">=</span><span
				class="pln"> show</span><span class="pun">;</span></pre>

		<p>
			Замечательно. Следующий шаг &mdash; немного более сложный, конечно.
			Первая проблема следующая: мы хотим обрабатывать загрузку файлов в нашем обработчике запроса <em>upload</em>, и тут надо будет передать объект <em>request</em> при вызове <em>form.parse</em> модуля <em>node-formidable</em>.
		</p>

		<p>
			Но всё, что у нас есть &mdash; это объект <em>response</em> и массив <em>postData</em>.
			Грустно.
			Похоже, что придётся передавать каждый раз объект <em>request</em> из сервера в роутер и обработчик запроса.
			Может быть, имеется более элегантное решение, но этот способ может делать работу уже сейчас.
		</p>

		<p>
			Давайте полностью удалим всё, что касается <em>postData</em> в нашем сервере и обработчиках запроса &mdash; он нам не нужен для обработки загрузки файла и, мало того, &mdash; даже создает проблему: мы уже «поглотили» события <em>data</em> объекта <em>request</em> в сервере, а следовательно, <em>form.parse</em>, которому так же надо поглащать эти события, не сможет получить больше данных (потому что Node.js не буферизирует данные).
		</p>

		<p>
			Начнём с <em>server.js</em> — удалим обработку postData и строку с <em>request.setEncoding</em> (node-formidable сам всё сделает) и передадим <em>request</em> в роутер:			
		</p>
		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> http </span><span
				class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span
				class="str">"http"</span><span class="pun">);</span><span class="pln"><br></span><span
				class="kwd">var</span><span class="pln"> url </span><span class="pun">=</span><span
				class="pln"> require</span><span class="pun">(</span><span class="str">"url"</span><span
				class="pun">);</span><span class="pln"><br><br></span><span class="kwd">function</span><span
				class="pln"> start</span><span class="pun">(</span><span class="pln">route</span><span
				class="pun">,</span><span class="pln"> handle</span><span class="pun">)</span><span class="pln"> </span><span
				class="pun">{</span><span class="pln"><br>&nbsp; </span><span class="kwd">function</span><span
				class="pln"> onRequest</span><span class="pun">(</span><span class="pln">request</span><span
				class="pun">,</span><span class="pln"> response</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span
				class="kwd">var</span><span class="pln"> pathname </span><span class="pun">=</span><span class="pln"> url</span><span
				class="pun">.</span><span class="pln">parse</span><span class="pun">(</span><span
				class="pln">request</span><span class="pun">.</span><span class="pln">url</span><span
				class="pun">).</span><span class="pln">pathname</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request for "</span><span
				class="pln"> </span><span class="pun">+</span><span class="pln"> pathname </span><span
				class="pun">+</span><span class="pln"> </span><span class="str">" received."</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; route</span><span class="pun">(</span><span
				class="pln">handle</span><span class="pun">,</span><span class="pln"> pathname</span><span
				class="pun">,</span><span class="pln"> response</span><span class="pun">,</span><span class="pln"> request</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; </span><span class="pun">}</span><span
				class="pln"><br><br>&nbsp; http</span><span class="pun">.</span><span
				class="pln">createServer</span><span class="pun">(</span><span class="pln">onRequest</span><span
				class="pun">).</span><span class="pln">listen</span><span class="pun">(</span><span
				class="lit">8888</span><span class="pun">);</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Server has started."</span><span
				class="pun">);</span><span class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br>exports</span><span
				class="pun">.</span><span class="pln">start </span><span class="pun">=</span><span
				class="pln"> start</span><span class="pun">;</span></pre>

		<p>
			Следующий &mdash; <em>router.js</em> — мы больше не передаём <em>postData</em>, а вместо этого передаём <em>request</em>:
		</p>
		
		<pre class="prettyprint lang-js"><span class="kwd">function</span><span class="pln"> route</span><span
				class="pun">(</span><span class="pln">handle</span><span class="pun">,</span><span
				class="pln"> pathname</span><span class="pun">,</span><span class="pln"> response</span><span
				class="pun">,</span><span class="pln"> request</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"About to route a request for "</span><span
				class="pln"> </span><span class="pun">+</span><span class="pln"> pathname</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; </span><span class="kwd">if</span><span
				class="pln"> </span><span class="pun">(</span><span class="kwd">typeof</span><span
				class="pln"> handle</span><span class="pun">[</span><span class="pln">pathname</span><span
				class="pun">]</span><span class="pln"> </span><span class="pun">===</span><span
				class="pln"> </span><span class="str">'function'</span><span class="pun">)</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; handle</span><span
				class="pun">[</span><span class="pln">pathname</span><span class="pun">](</span><span class="pln">response</span><span
				class="pun">,</span><span class="pln"> request</span><span class="pun">);</span><span class="pln"><br>&nbsp; </span><span
				class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span
				class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; console</span><span
				class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"No request handler found for "</span><span
				class="pln"> </span><span class="pun">+</span><span class="pln"> pathname</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">writeHead</span><span class="pun">(</span><span class="lit">404</span><span
				class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span
				class="str">"Content-Type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"text/html"</span><span
				class="pun">});</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">write</span><span class="pun">(</span><span class="str">"404 Not found"</span><span
				class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; response</span><span class="pun">.</span><span
				class="pln">end</span><span class="pun">();</span><span class="pln"><br>&nbsp; </span><span class="pun">}</span><span
				class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br>exports</span><span
				class="pun">.</span><span class="pln">route </span><span class="pun">=</span><span
				class="pln"> route</span><span class="pun">;</span></pre>

		<p>
			Теперь объект <em>request</em> может быть использован в функции обработчика запроса <em>upload</em>.
			<em>node-formidable</em> будет заниматься сохранением загруженного файла в локальный файл <em>/tmp</em>, но, конечно, мы сами должны сделать, чтобы этот файл переименовывался в <em>/tmp/test.png</em>.
			Да, мы придерживаемся действительно простых вещей и принимаем, что могут загружаться только PNG-картинки.
		</p>

		<p>
			Имеется небольшая дополнительная сложность в логике переименования: Windows-реализации Node.js не нравится, когда пытаются переименовать существующий файл, вот почему нам необходимо удалять файл в случае ошибки.
		</p>

		<p>
			Давайте добавим в <em>requestHandlers.js</em> код управления загрузкой файла и переименованием:			
		</p>
		<pre class="prettyprint lang-js"><span class="kwd">var</span><span class="pln"> querystring </span><span class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span class="str">"querystring"</span><span class="pun">),</span><span class="pln">
	fs </span><span class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span class="str">"fs"</span><span class="pun">),</span><span class="pln">
	formidable </span><span class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span class="str">"formidable"</span><span class="pun">);</span><span class="pln">

</span><span class="kwd">function</span><span class="pln"> start</span><span class="pun">(</span><span class="pln">response</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
  console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request handler 'start' was called."</span><span class="pun">);</span><span class="pln">

  </span><span class="kwd">var</span><span class="pln"> body </span><span class="pun">=</span><span class="pln"> </span><span class="str">'&lt;html&gt;'</span><span class="pun">+</span><span class="pln">
	</span><span class="str">'&lt;head&gt;'</span><span class="pun">+</span><span class="pln">
	</span><span class="str">'&lt;meta http-equiv="Content-Type" '</span><span class="pun">+</span><span class="pln">
	</span><span class="str">'content="text/html; charset=UTF-8" /&gt;'</span><span class="pun">+</span><span class="pln">
	</span><span class="str">'&lt;/head&gt;'</span><span class="pun">+</span><span class="pln">
	</span><span class="str">'&lt;body&gt;'</span><span class="pun">+</span><span class="pln">
	</span><span class="str">'&lt;form action="/upload" enctype="multipart/form-data" '</span><span class="pun">+</span><span class="pln">
	</span><span class="str">'method="post"&gt;'</span><span class="pun">+</span><span class="pln">
	</span><span class="str">'&lt;input type="file" name="upload" multiple="multiple"&gt;'</span><span class="pun">+</span><span class="pln">
	</span><span class="str">'&lt;input type="submit" value="Upload file" /&gt;'</span><span class="pun">+</span><span class="pln">
	</span><span class="str">'&lt;/form&gt;'</span><span class="pun">+</span><span class="pln">
	</span><span class="str">'&lt;/body&gt;'</span><span class="pun">+</span><span class="pln">
	</span><span class="str">'&lt;/html&gt;'</span><span class="pun">;</span><span class="pln">

	response</span><span class="pun">.</span><span class="pln">writeHead</span><span class="pun">(</span><span class="lit">200</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="str">"Content-Type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"text/html"</span><span class="pun">});</span><span class="pln">
	response</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">body</span><span class="pun">);</span><span class="pln">
	response</span><span class="pun">.</span><span class="pln">end</span><span class="pun">();</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="kwd">function</span><span class="pln"> upload</span><span class="pun">(</span><span class="pln">response</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
  console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request handler 'upload' was called."</span><span class="pun">);</span><span class="pln">

  </span><span class="kwd">var</span><span class="pln"> form </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> formidable</span><span class="pun">.</span><span class="typ">IncomingForm</span><span class="pun">();</span><span class="pln">
  console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"about to parse"</span><span class="pun">);</span><span class="pln">
  form</span><span class="pun">.</span><span class="pln">parse</span><span class="pun">(</span><span class="pln">request</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">error</span><span class="pun">,</span><span class="pln"> fields</span><span class="pun">,</span><span class="pln"> files</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
	console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"parsing done"</span><span class="pun">);</span><span class="pln">

</span><span class="com">/* Возможна ошибка в Windows: попытка переименования уже существующего файла */</span><span class="pln">
	fs</span><span class="pun">.</span><span class="pln">rename</span><span class="pun">(</span><span class="pln">files</span><span class="pun">.</span><span class="pln">upload</span><span class="pun">.</span><span class="pln">path</span><span class="pun">,</span><span class="pln"> </span><span class="str">"/tmp/test.png"</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
	  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
		fs</span><span class="pun">.</span><span class="pln">unlink</span><span class="pun">(</span><span class="str">"/tmp/test.png"</span><span class="pun">);</span><span class="pln">
		fs</span><span class="pun">.</span><span class="pln">rename</span><span class="pun">(</span><span class="pln">files</span><span class="pun">.</span><span class="pln">upload</span><span class="pun">.</span><span class="pln">path</span><span class="pun">,</span><span class="pln"> </span><span class="str">"/tmp/test.png"</span><span class="pun">);</span><span class="pln">
	  </span><span class="pun">}</span><span class="pln">
	</span><span class="pun">});</span><span class="pln">
	response</span><span class="pun">.</span><span class="pln">writeHead</span><span class="pun">(</span><span class="lit">200</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="str">"Content-Type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"text/html"</span><span class="pun">});</span><span class="pln">
	response</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="str">"received image:&lt;br/&gt;"</span><span class="pun">);</span><span class="pln">
	response</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="str">"&lt;img src='/show' /&gt;"</span><span class="pun">);</span><span class="pln">
	response</span><span class="pun">.</span><span class="pln">end</span><span class="pun">();</span><span class="pln">
  </span><span class="pun">});</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="kwd">function</span><span class="pln"> show</span><span class="pun">(</span><span class="pln">response</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
  console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">"Request handler 'show' was called."</span><span class="pun">);</span><span class="pln">
  fs</span><span class="pun">.</span><span class="pln">readFile</span><span class="pun">(</span><span class="str">"/tmp/test.png"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"binary"</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">error</span><span class="pun">,</span><span class="pln"> file</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
	</span><span class="kwd">if</span><span class="pun">(</span><span class="pln">error</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
	  response</span><span class="pun">.</span><span class="pln">writeHead</span><span class="pun">(</span><span class="lit">500</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="str">"Content-Type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"text/plain"</span><span class="pun">});</span><span class="pln">
	  response</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">error </span><span class="pun">+</span><span class="pln"> </span><span class="str">"\n"</span><span class="pun">);</span><span class="pln">
	  response</span><span class="pun">.</span><span class="pln">end</span><span class="pun">();</span><span class="pln">
	</span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
	  response</span><span class="pun">.</span><span class="pln">writeHead</span><span class="pun">(</span><span class="lit">200</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="str">"Content-Type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"image/png"</span><span class="pun">});</span><span class="pln">
	  response</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">file</span><span class="pun">,</span><span class="pln"> </span><span class="str">"binary"</span><span class="pun">);</span><span class="pln">
	  response</span><span class="pun">.</span><span class="pln">end</span><span class="pun">();</span><span class="pln">
	</span><span class="pun">}</span><span class="pln">
  </span><span class="pun">});</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

exports</span><span class="pun">.</span><span class="pln">start </span><span class="pun">=</span><span class="pln"> start</span><span class="pun">;</span><span class="pln">
exports</span><span class="pun">.</span><span class="pln">upload </span><span class="pun">=</span><span class="pln"> upload</span><span class="pun">;</span><span class="pln">
exports</span><span class="pun">.</span><span class="pln">show </span><span class="pun">=</span><span class="pln"> show</span><span class="pun">;</span></pre>

		<p>
			Вот и всё. Перезапускаем сервер, и последний пункт нашей задачи реализован.
			Выбираем локальную PNG-картинку с диска, загружаем на сервер и видим её на нашей веб-страничке.
		</p>

		<a name="conclusion-and-outlook"></a>

		<h2>Выводы и перспективы</h2>

		<p>
			Поздравляю, наша миссия выполнена!
			Мы написали простое, уже полностью готовое web-приложение на Node.js.
			Мы поговорили о server-side JavaScript, функциональном программировании, блокирующих и неблокирующих операциях, callback-ах, событиях, обычаях, внутренних и внешних модулях и о многом другом.
		</p>
		<p>
			Конечно, имеется много вещей, которые мы не обсудили: как общаться с базой данных, как писать unit-тесты, как создавать внешние модули, с возможностью инсталяции через NPM или даже что-нибудь простое, например, как обрабатывать GET-запросы.
		</p>
		<p>
			Но это судьба каждого учебника, предназначенного для начинающих — нельзя расказать о всех аспектах во всех деталях.
		</p>
		<p>
			Хорошей новостью является то, что Node.js-сообщество &mdash; очень активное (думаю, даже гиперактивное от кофеина, но в хорошем смысле), имеется множество ресурсов, кроме этого, и множество мест, где можно получить ответы на ваши вопросы.
			<a href="https://github.com/joyent/node/wiki">Node.js community wiki</a> и <a href="http://www.nodecloud.org/">the NodeCloud directory</a> являются, возможно, лучшими отправными точками.
		</p>
		</div>

		<div id="praise">
			<div class="praise">
				<div class="comment">
					«Я люблю nodebeginner.org &mdash; кратко, чётко и даже приятно читать»
				</div>
				<div class="author">Gojko Adzic, автор <em>Specification by Example</em> и <em>Bridging the Communication Gap</em></div>
			</div>
			<div class="praise">
				<div class="comment">
					«Это один из лучших туториалов, которые я читал. Как бывший Java-кодер, я всегда находил JavaScript приверженным чёрной магии, но с этим туториалом многие вещи стали простыми.»
				</div>
				<div class="author">Erskine, из комментариев</div>
			</div>
			<div class="praise">
				<div class="comment">
					«Это одна из немногих статей для новичков, которую я прочитал до конца &mdash; настолько хорошо она написана.»
				</div>
				<div class="author">
					Paul Gibler, из комментариев
				</div>
			</div>
			<div class="praise">
				<div class="comment">
					«Обязательный.»
				</div>
				<div class="author">
					@lecolibrilibre, в Twitter
				</div>
			</div>
			<div class="praise">
				<div class="comment">
					«Я просто хотел вам сказать спасибо за это замечательное введение в node. Ваше объяснение просто фантастическое, я не могу дождаться, когда вы закончите книгу.»
				</div>
				<div class="author">
					Seth McLaughlin, из email-письма
				</div>
			</div>
		</div>

		<div id="disqus_thread"></div>
		<script type="text/javascript">
			var disqus_shortname = 'nodebeginner-ru';
			var disqus_identifier = 'artod';
			var disqus_url = 'http://nodebeginner.ru/';

			(function() {
				var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		</script>

		<div id="footer">
			<p id="ccimage">
				<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"><img alt="Creative Commons License" border="0" src="creative_commons.png" width="88" height="31"/></a>
			</p>
			<p>
				<span xmlns:dct="http://purl.org/dc/terms/">The Node Beginner Book</span>
				by
				<a xmlns:cc="http://creativecommons.org/ns#" href="http://manuel.kiessling.net" rel="cc:attributionURL">Manuel Kiessling</a> (see <a href="https://plus.google.com/100272082905360445612?rel=author">Google+ profile</a>)
				is licensed under a
				<br />
				<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License</a>.
				<br />
				Permissions beyond the scope of this license may be available at <a xmlns:cc="http://creativecommons.org/ns#" href="mailto:manuel@kiessling.net" rel="cc:morePermissions">manuel@kiessling.net</a>.
			</p>
		</div>

		<div id='counter'>
			<!--LiveInternet counter--><script type="text/javascript"><!--
			document.write("<a href='http://www.liveinternet.ru/click' "+
			"target=_blank><img src='//counter.yadro.ru/hit?t45.6;r"+
			escape(document.referrer)+((typeof(screen)=="undefined")?"":
			";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
			screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
			";"+Math.random()+
			"' alt='' title='LiveInternet' "+
			"border='0' width='31' height='31'><\/a>")
			//--></script><!--/LiveInternet-->
		</div>

	</body>
</html>
